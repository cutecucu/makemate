<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ í•  ì¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        html {
            font-size: 14px; /* ê¸°ë³¸ í°íŠ¸ í¬ê¸°ë¥¼ ì¤„ì—¬ ì „ì²´ UIë¥¼ ì‘ê²Œ ë§Œë“­ë‹ˆë‹¤. */
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        @keyframes float-up {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
        }
        .emoji-animation {
            position: absolute;
            z-index: 100;
            animation: float-up 1s ease-out forwards;
            pointer-events: none; /* Make it unclickable */
        }
        .admin-header-bg {
            /* ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ ê¸°ë³¸ ë°°ê²½ ì´ë¯¸ì§€ (ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš°) */
            background-image: url('https://placehold.co/800x300/6d28d9/ffffff?text=Admin+Mode');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-md mx-auto h-screen bg-white shadow-lg flex flex-col relative overflow-hidden transition-all duration-300">
        <!-- í—¤ë” -->
        <header id="app-header" class="bg-gradient-to-br from-purple-500 to-pink-500 text-white py-4 px-4 shadow-lg z-20">
            <div class="flex justify-between items-center">
                <h1 id="main-title" class="text-2xl font-bold"><span id="header-username"></span><span id="header-title-text"> ì˜¤ëŠ˜ í•  ì¼</span></h1>
                <div id="header-icons" class="flex items-center space-x-2">
                    <input type="file" id="csv-file" accept=".csv" class="hidden">
                    <button id="import-csv-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                    </button>
                    <button id="shop-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </button>
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
                <div id="header-back-btn-container" class="hidden">
                     <button id="back-to-home-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="points-display-header" class="text-right mt-2 text-lg">
                ì´ í¬ì¸íŠ¸: <span class="total-points-display font-bold">0</span>ì 
            </div>

            <div id="profile-and-date-section">
                 <div id="profile-section" class="relative h-48 mt-2">
                    <!-- User Part (Left, slightly higher) -->
                    <div class="absolute top-4 left-0 flex items-center w-3/4 z-10">
                        <div class="relative group flex-shrink-0">
                            <img id="profile-img" src="" alt="Profile Picture" class="w-24 h-24 object-cover cursor-pointer transform -rotate-6 hover:rotate-0 hover:scale-110 transition-transform duration-300 shadow-lg">
                        </div>
                        <div id="user-speech-bubble" class="relative bg-white text-gray-800 p-3 -ml-4 rounded-lg shadow-lg cursor-pointer">
                            <div class="flex items-center justify-center">
                                <p id="user-quote-display" class="text-sm font-bold"></p>
                                <button id="generate-quote-btn" class="ml-2 text-purple-400 hover:text-purple-600">âœ¨</button>
                            </div>
                            <div class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 w-0 h-0 border-t-[8px] border-t-transparent border-b-[8px] border-b-transparent border-r-[8px] border-r-white"></div>
                        </div>
                    </div>
                    <!-- Admin Part (Right, slightly lower) -->
                    <div class="absolute bottom-4 right-0 flex items-center w-3/4 justify-end">
                        <div class="relative bg-purple-200 text-purple-900 p-3 -mr-4 rounded-lg shadow-lg z-10">
                            <p id="admin-message-display" class="text-sm"></p>
                             <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 w-0 h-0 border-t-[8px] border-t-transparent border-b-[8px] border-b-transparent border-l-[8px] border-l-purple-200"></div>
                        </div>
                        <div class="flex-shrink-0 z-0">
                            <img id="admin-profile-img" src="" alt="Admin Picture" class="w-24 h-24 object-cover transform rotate-6 shadow-lg">
                        </div>
                    </div>
                </div>
                
                <div id="date-navigation" class="flex justify-between items-center text-white mt-1">
                    <button id="prev-day-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 id="current-date-display" class="text-xl font-bold"></h2>
                    <button id="next-day-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- í• ì¼ ëª©ë¡ (íƒ€ì„ë¼ì¸) -->
        <main id="task-list" class="flex-1 overflow-y-auto py-4 px-4 sm:px-6 no-scrollbar bg-gray-50 relative">
            <!-- íƒ€ì„ë¼ì¸ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. -->
        </main>
        
        <!-- í¬ì¸íŠ¸ ìƒì  -->
        <main id="shop-page" class="hidden flex-1 overflow-y-auto py-4 px-4 sm:px-6 no-scrollbar bg-gray-50 relative">
             <div class="bg-white p-4 rounded-lg shadow-md mb-4 sticky top-0 z-10">
                <p class="text-lg text-center">
                    <span id="shop-user-name" class="font-bold"></span>ë‹˜ì˜ í˜„ì¬ í¬ì¸íŠ¸: <span class="total-points-display font-bold text-pink-600">0</span>ì 
                </p>
             </div>
             <div id="shop-items-container" class="space-y-3">
                <!-- ìƒì  ì•„ì´í…œì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. -->
             </div>
        </main>

        <!-- ê´€ë¦¬ì í˜ì´ì§€ -->
        <main id="admin-page" class="hidden flex-1 overflow-y-auto py-4 px-4 sm:px-6 no-scrollbar bg-gray-50 relative">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold mb-3">í˜ì´ì§€ ë””ìì¸</h3>
                        <div class="space-y-4">
                             <!-- Message Section -->
                            <div class="space-y-2 border-b pb-4">
                                <h4 class="font-bold text-md">ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="admin-message-jia" class="block text-sm font-medium text-gray-700">ì§€ì•„ì—ê²Œ:</label>
                                        <input type="text" id="admin-message-jia" class="w-full border rounded p-2 focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label for="admin-message-jihu" class="block text-sm font-medium text-gray-700">ì§€í›„ì—ê²Œ:</label>
                                        <input type="text" id="admin-message-jihu" class="w-full border rounded p-2 focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                                <button id="save-messages-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2">ë©”ì‹œì§€ ì €ì¥</button>
                            </div>

                             <!-- Background Image Section -->
                            <div class="space-y-4 border-b pb-4">
                                <h4 class="font-bold text-md">ë°°ê²½ ì´ë¯¸ì§€ ë“±ë¡</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">íƒ€ì´í‹€ ë°°ê²½ (í—¤ë”)</label>
                                        <p class="text-xs text-gray-500 mb-2">ê¶Œì¥ ì‚¬ì´ì¦ˆ: 800 x 300 í”½ì…€</p>
                                        <button id="upload-header-bg-btn" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">í”„ë¡œí•„ ë°°ê²½</label>
                                        <p class="text-xs text-gray-500 mb-2">ê¶Œì¥ ì‚¬ì´ì¦ˆ: 600 x 200 í”½ì…€</p>
                                        <button id="upload-profile-bg-btn" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profile Picture Management -->
                            <div class="space-y-4">
                                <h4 class="font-bold text-md">í”„ë¡œí•„ ì‚¬ì§„ ê´€ë¦¬</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">ì§€ì•„ í”„ë¡œí•„</label>
                                        <button id="upload-jia-profile-btn" class="mt-2 w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">ì‚¬ì§„ ì˜¬ë¦¬ê¸°</button>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">ì§€í›„ í”„ë¡œí•„</label>
                                        <button id="upload-jihu-profile-btn" class="mt-2 w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">ì‚¬ì§„ ì˜¬ë¦¬ê¸°</button>
                                    </div>
                                     <div>
                                        <label class="block text-sm font-medium text-gray-700">ê´€ë¦¬ì í”„ë¡œí•„</label>
                                        <button id="upload-admin-profile-btn" class="mt-2 w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">ì‚¬ì§„ ì˜¬ë¦¬ê¸°</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3">ì‚¬ìš©ì í•  ì¼ ë“±ë¡</h3>
                    <div class="space-y-2">
                         <select id="admin-add-task-user" class="w-full border rounded p-2">
                            <option value="ì§€ì•„">ì§€ì•„ì—ê²Œ ë“±ë¡</option>
                            <option value="ì§€í›„">ì§€í›„ì—ê²Œ ë“±ë¡</option>
                            <option value="ëª¨ë‘">ëª¨ë‘ì—ê²Œ ë“±ë¡</option>
                        </select>
                        <input type="date" id="admin-add-task-date" class="w-full border rounded p-2">
                        <select id="admin-add-task-time" class="w-full border rounded p-2"></select>
                        <input type="text" id="admin-add-task-text" placeholder="í•  ì¼ ë‚´ìš©" class="w-full border rounded p-2">
                        <input type="number" id="admin-add-task-points" placeholder="í¬ì¸íŠ¸" class="w-full border rounded p-2">
                        <button id="admin-add-task-btn" class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600 mt-2">í•  ì¼ ë“±ë¡</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3">ìƒì  ì•„ì´í…œ ê´€ë¦¬</h3>
                    <div class="flex items-center gap-2 mb-3">
                        <input type="text" id="new-item-name" placeholder="ìƒí’ˆ ì´ë¦„" class="flex-grow border rounded p-2 focus:ring-2 focus:ring-purple-500">
                        <input type="number" id="new-item-points" placeholder="í¬ì¸íŠ¸" class="w-24 border rounded p-2 text-center focus:ring-2 focus:ring-purple-500">
                        <button id="add-item-btn" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">ì¶”ê°€</button>
                    </div>
                     <div class="flex items-center mb-3">
                        <input type="checkbox" id="new-item-is-cash" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <label for="new-item-is-cash" class="ml-2 block text-sm text-gray-900">í˜„ê¸ˆ í™˜ì „ ì¿ í°</label>
                    </div>
                    <div id="admin-shop-items-container" class="space-y-3 border-t pt-3">
                        <!-- ê´€ë¦¬ììš© ìƒì  ì•„ì´í…œ ëª©ë¡ -->
                    </div>
                </div>

                 <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold mb-3">ì˜¤ëŠ˜ ì™„ë£Œí•œ í• ì¼ ë³´ê¸°</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-md text-pink-600">ì§€ì•„</h4>
                                <div id="admin-completed-jia" class="space-y-2 mt-2 border-t pt-2"></div>
                            </div>
                             <div class="">
                                <h4 class="font-bold text-md text-blue-600">ì§€í›„</h4>
                                <div id="admin-completed-jihu" class="space-y-2 mt-2 border-t pt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3">í˜„ê¸ˆ í™˜ì „ ìš”ì²­ ëª©ë¡</h3>
                    <div id="admin-cash-exchanges-container" class="space-y-3 border-t pt-3">
                        <!-- í™˜ì „ ìš”ì²­ ëª©ë¡ -->
                    </div>
                </div>
            </div>
        </main>


        <!-- í•˜ë‹¨ ë©”ë‰´ -->
        <footer class="p-4 bg-white border-t border-gray-200 z-10">
             <div id="home-footer-buttons" class="flex items-center gap-4">
                <button id="end-day-btn" class="flex-grow bg-green-500 text-white font-bold py-3 rounded-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">ì˜¤ëŠ˜ í•˜ë£¨ ë</button>
                <button id="show-add-task-modal-btn" class="flex-shrink-0 bg-purple-500 text-white w-14 h-14 rounded-full shadow-lg hover:bg-purple-600 flex items-center justify-center transition-transform transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
            </div>
        </footer>
    </div>
    
    <input type="file" id="profile-upload-input" class="hidden" accept="image/*">
    <input type="file" id="header-bg-upload-input" class="hidden" accept="image/*">
    <input type="file" id="profile-bg-upload-input" class="hidden" accept="image/*">
    <input type="file" id="admin-profile-upload-input" class="hidden" accept="image/*">
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex items-center justify-center z-[100]">
        <div class="text-purple-600 text-xl font-bold">ë¡œë”© ì¤‘...</div>
    </div>


    <!-- ì¼ë°˜ ë©”ì‹œì§€ ëª¨ë‹¬ -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <p id="modal-message" class="text-lg mb-4"></p>
            <button id="modal-close-btn" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">í™•ì¸</button>
        </div>
    </div>
    
    <!-- ì‚­ì œ/êµ¬ë§¤ í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <p id="confirm-message" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="confirm-ok-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">í™•ì¸</button>
            </div>
        </div>
    </div>

     <!-- ì¿ í° ì‚¬ìš©(êµ¬ë§¤) ëª¨ë‹¬ -->
    <div id="purchase-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 id="purchase-modal-title" class="text-xl font-bold mb-4"></h3>
            <p class="text-gray-600 mb-4">ì¿ í°ì„ ì‚¬ìš©í•  ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            <div class="space-y-3">
                <input type="date" id="purchase-date" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
                <select id="purchase-time" class="border rounded-lg p-2 w-full text-gray-700 bg-white"></select>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-purchase-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="confirm-purchase-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">ì‚¬ìš©í•˜ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- í˜„ê¸ˆ í™˜ì „ ëª¨ë‹¬ -->
    <div id="cash-exchange-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 id="cash-exchange-modal-title" class="text-xl font-bold mb-4">í˜„ê¸ˆ í™˜ì „</h3>
            <p class="text-gray-600 mb-2">í™˜ì „í•  í¬ì¸íŠ¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <p class="text-sm text-gray-500 mb-4">í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸: <span id="cash-exchange-current-points" class="font-bold">0</span>ì </p>
            <div class="space-y-3">
                <input type="number" id="cash-exchange-amount" placeholder="í™˜ì „í•  í¬ì¸íŠ¸" class="w-full border rounded-lg p-2 text-center focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-cash-exchange-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="confirm-cash-exchange-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">í™˜ì „í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ë‹¤ì§ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="quote-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 class="text-xl font-bold mb-4">ì˜¤ëŠ˜ì˜ ë‹¤ì§ ìˆ˜ì •</h3>
            <input type="text" id="edit-quote-input" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-edit-quote-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="save-edit-quote-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">ì €ì¥</button>
            </div>
        </div>
    </div>


    <!-- ì‚¬ìš©ì ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 class="text-xl font-bold mb-4">ì‚¬ìš©ì ì„¤ì •</h3>
            <p class="text-gray-600 mb-4">ì•±ì„ ì‚¬ìš©í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. ì´ ì„¤ì •ì€ ê¸°ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
            <div class="space-y-2">
                <label for="user-jia" class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-400">
                    <input type="radio" id="user-jia" name="user-select" value="ì§€ì•„" class="h-4 w-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                    <span class="ml-3 text-lg font-medium">ì§€ì•„</span>
                </label>
                <label for="user-jihu" class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-400">
                    <input type="radio" id="user-jihu" name="user-select" value="ì§€í›„" class="h-4 w-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                    <span class="ml-3 text-lg font-medium">ì§€í›„</span>
                </label>
                 <label for="user-admin" class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-400">
                    <input type="radio" id="user-admin" name="user-select" value="ê´€ë¦¬ì" class="h-4 w-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                    <span class="ml-3 text-lg font-medium">ê´€ë¦¬ì</span>
                </label>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-settings-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="save-settings-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">ì €ì¥</button>
            </div>
        </div>
    </div>


    <!-- í• ì¼ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="add-task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 id="add-task-modal-title" class="text-xl font-bold mb-4">ìƒˆë¡œìš´ í•  ì¼ ì¶”ê°€</h3>
             <button id="ai-task-recommend-btn" class="w-full bg-purple-100 text-purple-700 font-semibold py-2 px-4 rounded-lg hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition mb-4">
                âœ¨ AIë¡œ í•  ì¼ ì¶”ì²œë°›ê¸°
            </button>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                     <select id="new-task-time" class="border rounded-lg p-2 w-full text-gray-700 bg-white"></select>
                     <select id="new-task-category" class="border rounded-lg p-2 w-full text-gray-700 bg-white">
                        <option value="í•™ìŠµ">ğŸ”µ í•™ìŠµ</option>
                        <option value="ìƒí™œìŠµê´€">ğŸŸ¢ ìƒí™œìŠµê´€</option>
                        <option value="ê°œì¸í™œë™">ğŸŸ¡ ê°œì¸í™œë™</option>
                        <option value="ë³´ìƒ">ğŸŸ£ ë³´ìƒ</option>
                     </select>
                </div>
                <input type="text" id="new-task-text" placeholder="í•  ì¼ ë‚´ìš©" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
                <input type="text" id="new-task-memo" placeholder="ë©”ëª¨ (ì„ íƒ ì‚¬í•­)" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
                <input type="number" id="new-task-points" placeholder="í¬ì¸íŠ¸" class="w-full border rounded-lg p-2 text-center focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-add-task-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="confirm-add-task-btn" class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600">ì¶”ê°€</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, onSnapshot, query, where, updateDoc, deleteDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ì„¤ì • ---
        // ì¤‘ìš”: GitHub ë“± ì™¸ë¶€ì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´, ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì •ìœ¼ë¡œ ì´ ë¶€ë¶„ì„ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤!
        // 1. Firebase ì½˜ì†”(https://console.firebase.google.com/)ì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“œì„¸ìš”.
        // 2. í”„ë¡œì íŠ¸ ì„¤ì • > ì¼ë°˜ íƒ­ì—ì„œ 'ì›¹ ì•±'ì„ ë“±ë¡í•˜ê³  firebaseConfig ê°’ì„ ë³µì‚¬í•˜ì„¸ìš”.
        // 3. Firestore Databaseì™€ Authentication(ìµëª… ë¡œê·¸ì¸ í™œì„±í™”)ì„ í™œì„±í™”í•˜ì„¸ìš”.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyC7hwYS_Ww9q7_9kHewjlKPDmXzJPB1Hko",
                authDomain: "todolist-b9581.firebaseapp.com",
                projectId: "todolist-b9581",
                storageBucket: "todolist-b9581.firebasestorage.app",
                messagingSenderId: "184765484937",
                appId: "1:184765484937:web:15328e8f30d6b7f5cbdb58",
                measurementId: "G-2KS0DCH3NS"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        try {
            app = initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. ì„¤ì • ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", e);
            loadingOverlay.innerHTML = `<div class="text-red-500 text-center">Firebase ì—°ê²° ì‹¤íŒ¨.<br>ì„¤ì • ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
        }
        
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let currentUser = null; 
        let currentAppUser = 'ì§€ì•„'; 
        let tasksUnsubscribe = null;
        let userUnsubscribe = null;
        let shopUnsubscribe = null;
        let adminTasksUnsubscribe = null;
        let adminCashUnsubscribe = null;
        let designUnsubscribe = null;
        let confirmCallback = null;
        let synth = null;
        let currentDate = new Date();
        let adminProfileUploadTarget = null;


        const userProfiles = {
            'ì§€ì•„': { name: 'ì§€ì•„', img: 'https://placehold.co/100x100/f871b1/ffffff?text=Jia', quote: 'ì˜¤ëŠ˜ë„ í™”ì´íŒ…! âœ¨' },
            'ì§€í›„': { name: 'ì§€í›„', img: 'https://placehold.co/100x100/60a5fa/ffffff?text=Jihu', quote: 'ìµœê³ ì˜ í•˜ë£¨ë¥¼ ë§Œë“¤ì! ğŸš€' },
            'ê´€ë¦¬ì': { name: 'ê´€ë¦¬ì', img: 'https://placehold.co/100x100/a855f7/ffffff?text=Admin', quote: 'ìƒì  ë° ì‚¬ìš©ì ê´€ë¦¬' }
        };

        const categoryColors = {
            'í•™ìŠµ':     { border: 'border-l-blue-500', timeBg: 'bg-blue-500' },
            'ìƒí™œìŠµê´€': { border: 'border-l-green-500', timeBg: 'bg-green-500' },
            'ê°œì¸í™œë™': { border: 'border-l-yellow-500', timeBg: 'bg-yellow-500' },
            'ë³´ìƒ':     { border: 'border-l-purple-500', timeBg: 'bg-purple-500' },
            'default':  { border: 'border-l-gray-300', timeBg: 'bg-gray-400' }
        };

        // --- DOM ìš”ì†Œ ---
        const appEl = document.getElementById('app');
        const appHeader = document.getElementById('app-header');
        const mainTitle = document.getElementById('main-title'), headerUsername = document.getElementById('header-username'), headerTitleText = document.getElementById('header-title-text'), headerIcons = document.getElementById('header-icons'), headerBackBtnContainer = document.getElementById('header-back-btn-container'), backToHomeBtn = document.getElementById('back-to-home-btn');
        const profileAndDateSection = document.getElementById('profile-and-date-section');
        const prevDayBtn = document.getElementById('prev-day-btn'), nextDayBtn = document.getElementById('next-day-btn'), currentDateDisplay = document.getElementById('current-date-display');
        const profileImg = document.getElementById('profile-img'), userQuoteDisplay = document.getElementById('user-quote-display'), adminMessageDisplay = document.getElementById('admin-message-display'), totalPointsDisplays = document.querySelectorAll('.total-points-display'), taskListEl = document.getElementById('task-list'), endDayBtn = document.getElementById('end-day-btn'), importCsvBtn = document.getElementById('import-csv-btn'), csvFileInput = document.getElementById('csv-file');
        const messageModal = document.getElementById('message-modal'), modalMessage = document.getElementById('modal-message'), modalCloseBtn = document.getElementById('modal-close-btn');
        const confirmModal = document.getElementById('confirm-modal'), confirmMessage = document.getElementById('confirm-message'), confirmCancelBtn = document.getElementById('confirm-cancel-btn'), confirmOkBtn = document.getElementById('confirm-ok-btn');
        const addTaskModal = document.getElementById('add-task-modal'), showAddTaskModalBtn = document.getElementById('show-add-task-modal-btn'), cancelAddTaskBtn = document.getElementById('cancel-add-task-btn'), confirmAddTaskBtn = document.getElementById('confirm-add-task-btn'), newTaskTimeInput = document.getElementById('new-task-time'), newTaskCategoryInput = document.getElementById('new-task-category'), newTaskTextInput = document.getElementById('new-task-text'), newTaskMemoInput = document.getElementById('new-task-memo'), newTaskPointsInput = document.getElementById('new-task-points'), addTaskModalTitle = document.getElementById('add-task-modal-title');
        const profileUploadInput = document.getElementById('profile-upload-input'), headerBgUploadInput = document.getElementById('header-bg-upload-input'), profileBgUploadInput = document.getElementById('profile-bg-upload-input'), adminProfileUploadInput = document.getElementById('admin-profile-upload-input');
        const settingsBtn = document.getElementById('settings-btn'), settingsModal = document.getElementById('settings-modal'), cancelSettingsBtn = document.getElementById('cancel-settings-btn'), saveSettingsBtn = document.getElementById('save-settings-btn');
        const shopBtn = document.getElementById('shop-btn'), shopPage = document.getElementById('shop-page'), shopItemsContainer = document.getElementById('shop-items-container'), shopUserName = document.getElementById('shop-user-name'), homeFooterButtons = document.getElementById('home-footer-buttons');
        const adminPage = document.getElementById('admin-page'), adminShopItemsContainer = document.getElementById('admin-shop-items-container'), newItemName = document.getElementById('new-item-name'), newItemPoints = document.getElementById('new-item-points'), addItemBtn = document.getElementById('add-item-btn');
        const purchaseModal = document.getElementById('purchase-modal'), purchaseModalTitle = document.getElementById('purchase-modal-title'), purchaseDateInput = document.getElementById('purchase-date'), purchaseTimeInput = document.getElementById('purchase-time'), cancelPurchaseBtn = document.getElementById('cancel-purchase-btn'), confirmPurchaseBtn = document.getElementById('confirm-purchase-btn');
        const adminMessageJia = document.getElementById('admin-message-jia'), adminMessageJihu = document.getElementById('admin-message-jihu'), saveMessagesBtn = document.getElementById('save-messages-btn');
        const adminCompletedJia = document.getElementById('admin-completed-jia'), adminCompletedJihu = document.getElementById('admin-completed-jihu');
        const adminAddTaskUser = document.getElementById('admin-add-task-user'), adminAddTaskDate = document.getElementById('admin-add-task-date'), adminAddTaskTime = document.getElementById('admin-add-task-time'), adminAddTaskText = document.getElementById('admin-add-task-text'), adminAddTaskPoints = document.getElementById('admin-add-task-points'), adminAddTaskBtn = document.getElementById('admin-add-task-btn');
        const cashExchangeModal = document.getElementById('cash-exchange-modal'), cashExchangeModalTitle = document.getElementById('cash-exchange-modal-title'), cashExchangeCurrentPoints = document.getElementById('cash-exchange-current-points'), cashExchangeAmountInput = document.getElementById('cash-exchange-amount'), cancelCashExchangeBtn = document.getElementById('cancel-cash-exchange-btn'), confirmCashExchangeBtn = document.getElementById('confirm-cash-exchange-btn');
        const newItemIsCash = document.getElementById('new-item-is-cash');
        const adminCashExchangesContainer = document.getElementById('admin-cash-exchanges-container');
        const uploadHeaderBgBtn = document.getElementById('upload-header-bg-btn'), uploadProfileBgBtn = document.getElementById('upload-profile-bg-btn');
        const adminProfileImg = document.getElementById('admin-profile-img');
        const generateQuoteBtn = document.getElementById('generate-quote-btn');
        const aiTaskRecommendBtn = document.getElementById('ai-task-recommend-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const quoteEditModal = document.getElementById('quote-edit-modal'), editQuoteInput = document.getElementById('edit-quote-input'), cancelEditQuoteBtn = document.getElementById('cancel-edit-quote-btn'), saveEditQuoteBtn = document.getElementById('save-edit-quote-btn');
        const userSpeechBubble = document.getElementById('user-speech-bubble');
        const pointsDisplayHeader = document.getElementById('points-display-header');
        const uploadJiaProfileBtn = document.getElementById('upload-jia-profile-btn'), uploadJihuProfileBtn = document.getElementById('upload-jihu-profile-btn'), uploadAdminProfileBtn = document.getElementById('upload-admin-profile-btn');

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        const dateToYYYYMMDD = (d) => {
            const date = new Date(d);
            // Use local date parts to avoid timezone shift from toISOString()
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const formatTimeForDisplay = (timeString) => {
            if (!timeString) return '';
            const [h, m] = timeString.split(':').map(Number);
            const minutes = String(m).padStart(2, '0');

            if (h === 0) {
                return `ì˜¤ì „ 12:${minutes}`;
            } else if (h < 12) {
                return `ì˜¤ì „ ${String(h).padStart(2, '0')}:${minutes}`;
            } else if (h === 12) {
                return `ì˜¤í›„ 12:${minutes}`;
            } else {
                return `ì˜¤í›„ ${String(h - 12).padStart(2, '0')}:${minutes}`;
            }
        };

        const getRelativeDateInfo = (d) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(d);
            targetDate.setHours(0, 0, 0, 0);
            
            const diffTime = targetDate - today;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return { label: 'ì˜¤ëŠ˜', isToday: true, isPast: false };
            if (diffDays === -1) return { label: 'ì–´ì œ', isToday: false, isPast: true };
            if (diffDays === 1) return { label: 'ë‚´ì¼', isToday: false, isPast: false };
            
            const formattedDate = `${targetDate.getMonth() + 1}ì›” ${targetDate.getDate()}ì¼`;
            return { label: formattedDate, isToday: false, isPast: diffDays < 0 };
        };

        const showModal = (message) => { modalMessage.textContent = message; messageModal.classList.remove('hidden'); messageModal.classList.add('flex'); };
        const hideModal = () => { messageModal.classList.add('hidden'); messageModal.classList.remove('flex'); };
        const showConfirm = (message, onConfirm, okText = 'í™•ì¸', okColor = 'bg-red-500') => {
            confirmMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmOkBtn.textContent = okText;
            confirmOkBtn.className = `px-6 py-2 rounded-lg text-white ${okColor} hover:opacity-90`;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        };
        const populateTimeSelect = (selectElement) => {
            selectElement.innerHTML = '';
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const displayText = formatTimeForDisplay(timeValue);
                    selectElement.add(new Option(displayText, timeValue));
                }
            }
        };

        // --- í˜ì´ì§€ ì „í™˜ ---
        const showAdminPage = () => {
            appEl.classList.remove('max-w-md');
            appEl.classList.add('md:max-w-6xl');
            appHeader.classList.add('admin-header-bg');
            mainTitle.innerHTML = `<span id="header-title-text">ê´€ë¦¬ì í˜ì´ì§€</span>`;
            headerIcons.classList.remove('hidden'); // ì„¤ì • ë²„íŠ¼ì„ ìœ„í•´ í‘œì‹œ
            headerBackBtnContainer.classList.add('hidden');
            profileAndDateSection.classList.add('hidden');
            pointsDisplayHeader.classList.add('hidden');
            taskListEl.classList.add('hidden');
            shopPage.classList.add('hidden');
            adminPage.classList.remove('hidden');
            homeFooterButtons.classList.add('hidden');
        };

        const showShopPage = () => {
            appEl.classList.add('max-w-md');
            appEl.classList.remove('md:max-w-6xl');
            appHeader.classList.remove('admin-header-bg');
            mainTitle.textContent = "í¬ì¸íŠ¸ ìƒì ";
            headerIcons.classList.add('hidden');
            headerBackBtnContainer.classList.remove('hidden');
            profileAndDateSection.classList.add('hidden');
            pointsDisplayHeader.classList.remove('hidden');
            taskListEl.classList.add('hidden');
            shopPage.classList.remove('hidden');
            adminPage.classList.add('hidden');
            homeFooterButtons.classList.add('hidden');
        };
        
        const showHomePage = () => {
            appEl.classList.add('max-w-md');
            appEl.classList.remove('md:max-w-6xl');
            appHeader.classList.remove('admin-header-bg');
            const userText = currentAppUser === 'ê´€ë¦¬ì' ? '' : `${currentAppUser}ì˜ `;
            mainTitle.innerHTML = `<span id="header-username">${userText}</span><span id="header-title-text"> ì˜¤ëŠ˜ í•  ì¼</span>`;
            headerIcons.classList.remove('hidden');
            headerBackBtnContainer.classList.add('hidden');
            profileAndDateSection.classList.remove('hidden');
            pointsDisplayHeader.classList.remove('hidden');
            taskListEl.classList.remove('hidden');
            shopPage.classList.add('hidden');
            adminPage.classList.add('hidden');
            homeFooterButtons.classList.remove('hidden');
        };

        // --- íƒ€ì„ë¼ì¸ UI ë Œë”ë§ ---
        const createTaskCard = (task, isReadOnly) => {
            const taskEl = document.createElement('div');
            const categoryStyle = categoryColors[task.category] || categoryColors.default;
            taskEl.className = `flex-1 flex items-center p-3 shadow-sm transition-all duration-300 bg-white border-l-4 ${task.completed ? 'bg-green-50' : ''} ${categoryStyle.border}`;
            
            const linkHTML = task.link ? `
                <a href="${task.link.startsWith('http') ? task.link : '//' + task.link}" target="_blank" class="text-blue-500 hover:text-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0m-2.828-2.828a2 2 0 012.828 0l3 3a2 2 0 11-2.828 2.828m-3 3a2 2 0 11-2.828-2.828l3-3a2 2 0 012.828 0" clip-rule="evenodd" /></svg>
                </a>` : '';
            
            const postponeBtnHTML = `
                <button data-id="${task.id}" data-time="${task.time}" class="postpone-task-btn text-blue-400 hover:text-blue-600 ${isReadOnly ? 'hidden' : ''}">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                   </svg>
                </button>`;

            taskEl.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-lg ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</p>
                    <div class="mt-1 space-y-1">
                        ${task.memo ? `<p class="text-sm text-gray-500 ${task.completed ? 'line-through' : ''}">${task.memo}</p>` : ''}
                        ${task.completed && task.completedTime ? `<p class="text-xs text-green-600 font-medium">âœ… ì™„ë£Œ: ${task.completedTime}</p>` : ''}
                    </div>
                </div>
                <div class="text-right flex-shrink-0 flex flex-col items-center space-y-1 pl-2">
                    <span class="font-bold text-pink-600 text-lg">${task.points} P</span>
                    <div class="flex items-center space-x-2 h-5">
                      ${postponeBtnHTML}
                      ${linkHTML}
                      <button data-id="${task.id}" class="delete-task-btn text-red-400 hover:text-red-600 ${isReadOnly ? 'hidden' : ''}">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                      </button>
                    </div>
                </div>
            `;
            return taskEl;
        };
        
        const renderTasks = (tasks, isReadOnly) => {
            taskListEl.innerHTML = '';
            const tasksByTime = tasks.reduce((acc, task) => { (acc[task.time] = acc[task.time] || []).push(task); return acc; }, {});
            const sortedTimes = Object.keys(tasksByTime).sort();

            if (sortedTimes.length === 0) {
                taskListEl.innerHTML = `<p class="text-center text-gray-500 mt-10">${getRelativeDateInfo(currentDate).label} í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            } else {
                for (const timeString of sortedTimes) {
                    const slotEl = document.createElement('div');
                    slotEl.className = 'flex';
                    slotEl.dataset.time = timeString;

                    const tasksForThisTime = tasksByTime[timeString];
                    
                    const timelineHTML = `<div class="w-8 text-center flex-shrink-0 relative pt-1"><div class="absolute top-8 left-1/2 w-px h-[calc(100%-2rem)] border-l-2 border-dotted border-gray-300 -z-10"></div></div>`;
                    const cardsContainer = document.createElement('div');
                    cardsContainer.className = "w-full";

                    tasksForThisTime.sort((a,b) => a.text.localeCompare(b.text)).forEach((task, index) => {
                        const taskWrapper = document.createElement('div');
                        taskWrapper.className = "flex items-start mb-2";
                        const displayTime = formatTimeForDisplay(timeString);

                        const timeAndCheckHTML = `
                            <div class="w-8 flex-shrink-0 flex flex-col items-center pt-1">
                                ${index === 0 ? `<div class="px-2 py-0.5 inline-block text-white text-xs font-bold time-bg ${ (categoryColors[task.category] || categoryColors.default).timeBg } mb-2">${displayTime}</div>` : '<div class="h-8"></div>'}
                                <input type="checkbox" data-id="${task.id}" class="h-6 w-6 rounded-full border-gray-300 text-purple-600 focus:ring-purple-500 cursor-pointer" ${task.completed ? 'checked' : ''} ${isReadOnly ? 'disabled' : ''}>
                            </div>`;
                        
                        taskWrapper.innerHTML = timeAndCheckHTML;
                        taskWrapper.appendChild(createTaskCard(task, isReadOnly));
                        cardsContainer.appendChild(taskWrapper);
                    });

                    slotEl.innerHTML = timelineHTML;
                    slotEl.appendChild(cardsContainer);
                    taskListEl.appendChild(slotEl);
                }
            }
        };

        const renderAdminCompletedTasks = (tasks) => {
            const jiaContainer = adminCompletedJia;
            const jihuContainer = adminCompletedJihu;
            jiaContainer.innerHTML = '';
            jihuContainer.innerHTML = '';

            const jiaTasks = tasks.filter(t => t.owner === 'ì§€ì•„').sort((a,b) => a.time.localeCompare(b.time));
            const jihuTasks = tasks.filter(t => t.owner === 'ì§€í›„').sort((a,b) => a.time.localeCompare(b.time));

            if (jiaTasks.length === 0) jiaContainer.innerHTML = `<p class="text-sm text-gray-500">ì™„ë£Œí•œ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            jiaTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'text-sm p-2 bg-gray-50 rounded';
                taskEl.textContent = `${formatTimeForDisplay(task.time)} - ${task.text} (+${task.points}P)`;
                jiaContainer.appendChild(taskEl);
            });

            if (jihuTasks.length === 0) jihuContainer.innerHTML = `<p class="text-sm text-gray-500">ì™„ë£Œí•œ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            jihuTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'text-sm p-2 bg-gray-50 rounded';
                taskEl.textContent = `${formatTimeForDisplay(task.time)} - ${task.text} (+${task.points}P)`;
                jihuContainer.appendChild(taskEl);
            });
        };

        const renderAdminCashExchanges = (requests) => {
            const container = adminCashExchangesContainer;
            container.innerHTML = '';
            if (requests.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">í™˜ì „ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }
            requests.sort((a, b) => (b.requestedAt?.toMillis() || 0) - (a.requestedAt?.toMillis() || 0));
            requests.forEach(req => {
                const reqEl = document.createElement('div');
                reqEl.className = 'bg-gray-50 p-3 rounded-lg flex justify-between items-center';
                const date = req.requestedAt ? req.requestedAt.toDate().toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                reqEl.innerHTML = `
                    <div>
                        <p class="font-bold">${req.userId}ë‹˜ì˜ ìš”ì²­</p>
                        <p class="text-sm text-green-600">${req.pointsExchanged.toLocaleString()} í¬ì¸íŠ¸ í™˜ì „</p>
                        <p class="text-xs text-gray-500">${date}</p>
                    </div>
                    <button data-id="${req.id}" class="complete-exchange-btn bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 text-sm">ì™„ë£Œ ì²˜ë¦¬</button>
                `;
                container.appendChild(reqEl);
            });
        };

        const renderShopItems = (items) => {
            shopItemsContainer.innerHTML = '';
            if (items.length === 0) {
                shopItemsContainer.innerHTML = `<p class="text-center text-gray-500 mt-10">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }
            items.forEach(item => {
                const isCashItem = item.type === 'cash';
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
                itemEl.innerHTML = `
                    <div>
                        <p class="text-lg font-bold">${item.name} ${isCashItem ? 'ğŸ’°' : ''}</p>
                        <p class="text-purple-600 font-bold">${isCashItem ? 'í¬ì¸íŠ¸ ì°¨ê°' : item.points.toLocaleString() + ' P'}</p>
                    </div>
                    <button data-id="${item.id}" data-name="${item.name}" data-points="${item.points}" data-type="${item.type || 'coupon'}" class="buy-item-btn bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">${isCashItem ? 'í™˜ì „' : 'êµ¬ë§¤'}</button>
                `;
                shopItemsContainer.appendChild(itemEl);
            });
        };

        const renderAdminShopItems = (items) => {
             adminShopItemsContainer.innerHTML = '';
            if (items.length === 0) {
                adminShopItemsContainer.innerHTML = `<p class="text-center text-gray-500 mt-4">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>`;
                return;
            }
            items.forEach(item => {
                const isCashItem = item.type === 'cash';
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
                itemEl.innerHTML = `
                    <div>
                        <p class="text-lg font-bold">${item.name} ${isCashItem ? 'ğŸ’°' : ''}</p>
                        <p class="text-purple-600 font-bold">${isCashItem ? 'í¬ì¸íŠ¸ ì°¨ê°' : item.points.toLocaleString() + ' P'}</p>
                    </div>
                    <button data-id="${item.id}" class="delete-item-btn bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">ì‚­ì œ</button>
                `;
                adminShopItemsContainer.appendChild(itemEl);
            });
        };
        
        const updateDateUI = () => {
            const dateInfo = getRelativeDateInfo(currentDate);
            const dateString = `${currentDate.getMonth() + 1}ì›” ${currentDate.getDate()}ì¼ (${dateInfo.label})`;
            
            currentDateDisplay.textContent = dateString;
            addTaskModalTitle.textContent = `${dateInfo.label} í•  ì¼ ì¶”ê°€`;
            
            showAddTaskModalBtn.style.display = dateInfo.isPast ? 'none' : 'flex';
        };

        const updateUIForUser = () => {
            shopUserName.textContent = currentAppUser;
            subscribeToData();
        };
        
        const playSoundAndAnimate = (event, isChecked) => {
             const synth = new window.Tone.Synth().toDestination();
            if (typeof window.Tone !== 'undefined') {
                if (window.Tone.context.state !== 'running') window.Tone.start();
                if (isChecked) {
                    synth.triggerAttackRelease("C5", "8n", window.Tone.now());
                } else {
                    synth.triggerAttackRelease("G4", "8n", window.Tone.now());
                }
            }
            if (isChecked) {
                const rect = event.target.getBoundingClientRect(), appRect = appEl.getBoundingClientRect();
                const emoji = document.createElement('span');
                const emojis = ['âœ¨', 'ğŸ‰', 'ğŸ‘', 'âœ…', 'ğŸ’¯', 'â­'];
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.className = 'emoji-animation text-3xl';
                emoji.style.left = `${rect.left - appRect.left}px`;
                emoji.style.top = `${rect.top - appRect.top}px`;
                appEl.appendChild(emoji);
                emoji.addEventListener('animationend', () => emoji.remove());
            }
        };

        // --- Gemini API ë¡œì§ ---
        const callGeminiAPI = async (prompt) => {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            
            const apiKey = ""; // API í‚¤ëŠ” ë¹„ì›Œ ë‘¡ë‹ˆë‹¤.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    throw new Error("No text returned from API.");
                }
                return text.trim();
            } catch (error) {
                console.error("Gemini API Error:", error);
                showModal("AI ê¸°ëŠ¥ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                return null;
            } finally {
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');
            }
        };

        // --- Firestore ë¡œì§ ---
        const subscribeToData = () => {
            if (!currentUser) return; // ì¸ì¦ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            if (tasksUnsubscribe) { tasksUnsubscribe(); tasksUnsubscribe = null; }
            if (userUnsubscribe) { userUnsubscribe(); userUnsubscribe = null; }
            if (shopUnsubscribe) { shopUnsubscribe(); shopUnsubscribe = null; }
            if (adminTasksUnsubscribe) { adminTasksUnsubscribe(); adminTasksUnsubscribe = null; }
            if (adminCashUnsubscribe) { adminCashUnsubscribe(); adminCashUnsubscribe = null; }
            if (designUnsubscribe) { designUnsubscribe(); designUnsubscribe = null; }

            const designDocRef = doc(db, `artifacts/${appId}/public/data/designConfig/main`);
            designUnsubscribe = onSnapshot(designDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const designData = docSnap.data();
                    if (designData.headerBgBase64) {
                        appHeader.style.backgroundImage = `url(${designData.headerBgBase64})`;
                        appHeader.style.backgroundSize = 'cover';
                        appHeader.style.backgroundPosition = 'center';
                        appHeader.classList.remove('bg-gradient-to-br', 'from-purple-500', 'to-pink-500');
                    } else {
                        appHeader.style.backgroundImage = '';
                        appHeader.classList.add('bg-gradient-to-br', 'from-purple-500', 'to-pink-500');
                    }

                    if (designData.profileBgBase64) {
                        document.getElementById('profile-section').style.backgroundImage = `url(${designData.profileBgBase64})`;
                        document.getElementById('profile-section').style.backgroundSize = 'cover';
                        document.getElementById('profile-section').style.backgroundPosition = 'center';
                    } else {
                        document.getElementById('profile-section').style.backgroundImage = '';
                    }

                    if (designData.adminProfileImgBase64) {
                         adminProfileImg.src = designData.adminProfileImgBase64;
                    } else {
                         adminProfileImg.src = userProfiles['ê´€ë¦¬ì'].img;
                    }
                } else {
                     adminProfileImg.src = userProfiles['ê´€ë¦¬ì'].img;
                }
            });

            const shopItemsRef = collection(db, `artifacts/${appId}/public/data/shopItems`);
            shopUnsubscribe = onSnapshot(shopItemsRef, (snapshot) => {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderShopItems(items);
                if (currentAppUser === 'ê´€ë¦¬ì') {
                   renderAdminShopItems(items);
                }
            });

            if (currentAppUser === 'ê´€ë¦¬ì') {
                showAdminPage();
                const todayString = dateToYYYYMMDD(new Date());
                const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
                const qAdminTasks = query(tasksRef, where("date", "==", todayString), where("completed", "==", true));
                adminTasksUnsubscribe = onSnapshot(qAdminTasks, (snapshot) => {
                    const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAdminCompletedTasks(tasks);
                });
                
                const cashExchangesRef = collection(db, `artifacts/${appId}/public/data/cashExchanges`);
                adminCashUnsubscribe = onSnapshot(cashExchangesRef, (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAdminCashExchanges(requests);
                });

                getDoc(doc(db, `artifacts/${appId}/public/data/users/ì§€ì•„`)).then(doc => { if(doc.exists()) adminMessageJia.value = doc.data().adminMessage || ''});
                getDoc(doc(db, `artifacts/${appId}/public/data/users/ì§€í›„`)).then(doc => { if(doc.exists()) adminMessageJihu.value = doc.data().adminMessage || ''});

                return;
            }
            
            showHomePage();

            const dateInfo = getRelativeDateInfo(currentDate);
            const dateString = dateToYYYYMMDD(currentDate);

            const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
            const qTasks = query(tasksRef, where("owner", "==", currentAppUser), where("date", "==", dateString));
            tasksUnsubscribe = onSnapshot(qTasks, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(tasks, dateInfo.isPast);
            });

            const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
            userUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const points = userData.points || 0;
                    totalPointsDisplays.forEach(el => el.textContent = points.toLocaleString());
                    
                    if(userData.adminMessage) {
                        adminMessageDisplay.textContent = `${userData.adminMessage}`;
                    } else {
                        adminMessageDisplay.textContent = "";
                    }
                    
                    userQuoteDisplay.textContent = userData.quote || userProfiles[currentAppUser].quote;
                    
                    if (userData.profileImgBase64) {
                        profileImg.src = userData.profileImgBase64;
                    } else {
                        profileImg.src = userProfiles[currentAppUser].img;
                    }
                    
                    const todayString = dateToYYYYMMDD(new Date());
                    const dateInfo = getRelativeDateInfo(currentDate);

                    if (dateInfo.isToday) {
                        endDayBtn.style.display = 'block';
                        if (userData.lastCompletionDate === todayString) {
                            endDayBtn.textContent = 'ì˜¤ëŠ˜ ë¯¸ì…˜ ì™„ë£Œ! ğŸ‰';
                            endDayBtn.disabled = true;
                        } else {
                            endDayBtn.textContent = 'ì˜¤ëŠ˜ í•˜ë£¨ ë';
                            endDayBtn.disabled = false;
                        }
                    } else {
                        endDayBtn.style.display = 'none';
                    }

                } else {
                    // ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
                    profileImg.src = userProfiles[currentAppUser].img;
                    setDoc(userDocRef, { name: currentAppUser, points: 0, lastCompletionDate: null, profileImgBase64: null, adminMessage: '', quote: userProfiles[currentAppUser].quote });
                }
            });
        };
        
        const handlePostponeTask = async (taskId, timeString) => {
            const [hours, minutes] = timeString.split(':').map(Number);
            let newHours = hours + 1;

            if (newHours >= 24) {
                showModal("23ì‹œ ì´í›„ì˜ ì¼ì •ì€ ë” ì´ìƒ ë¯¸ë£° ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            const newTimeString = `${String(newHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

            const taskDocRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);

            try {
                const userDoc = await getDoc(userDocRef);
                const currentPoints = userDoc.exists() ? userDoc.data().points : 0;
                
                await updateDoc(taskDocRef, { time: newTimeString });
                await setDoc(userDocRef, { points: Math.max(0, currentPoints - 100) }, { merge: true });
            } catch(e) {
                showModal("ì¼ì • ë¯¸ë£¨ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                console.error(e);
            }
        };

        const resizeImage = (file, maxWidth, maxHeight, quality) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/png'));
                    }
                    img.onerror = (error) => reject(error);
                }
                reader.onerror = (error) => reject(error);
            });
        };


        const handleProfileImageUpload = async (event, targetUser) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const resizedBase64 = await resizeImage(file, 200, 200, 0.8);
                if(!resizedBase64) return;
                
                const userToUpdate = targetUser || currentAppUser;

                if (userToUpdate === 'ê´€ë¦¬ì') {
                    const designDocRef = doc(db, `artifacts/${appId}/public/data/designConfig/main`);
                    await setDoc(designDocRef, { adminProfileImgBase64: resizedBase64 }, { merge: true });
                } else {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${userToUpdate}`);
                    await setDoc(userDocRef, { profileImgBase64: resizedBase64 }, { merge: true });
                }

                showModal(`${userToUpdate}ì˜ í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (err) {
                showModal('í”„ë¡œí•„ ì‚¬ì§„ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error("Profile image upload error:", err);
            } finally {
                event.target.value = '';
            }
        };
        
        const handleBgImageUpload = async (event, type) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                let resizedBase64;
                if (type === 'header') {
                    resizedBase64 = await resizeImage(file, 800, 300, 0.8);
                } else if (type === 'profile') {
                    resizedBase64 = await resizeImage(file, 600, 200, 0.8);
                }

                if (!resizedBase64) return;
                const designDocRef = doc(db, `artifacts/${appId}/public/data/designConfig/main`);
                
                if (type === 'header') {
                    await setDoc(designDocRef, { headerBgBase64: resizedBase64 }, { merge: true });
                } else if (type === 'profile') {
                    await setDoc(designDocRef, { profileBgBase64: resizedBase64 }, { merge: true });
                }
                showModal(`${type === 'header' ? 'í—¤ë”' : 'í”„ë¡œí•„'} ë°°ê²½ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (err) {
                showModal('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error("Image resize/upload error:", err);
            } finally {
                event.target.value = ''; // Reset file input
            }
        };


        const handleAddTask = async () => {
            const task = {
                text: newTaskTextInput.value.trim(), time: newTaskTimeInput.value,
                points: parseInt(newTaskPointsInput.value, 10), memo: newTaskMemoInput.value.trim(),
                category: newTaskCategoryInput.value
            };
            if (!task.text || !task.time || isNaN(task.points)) {
                showModal('ì‹œê°„, í•  ì¼, í¬ì¸íŠ¸ë¥¼ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), {
                    ...task, owner: currentAppUser, completed: false,
                    completedTime: null, link: null, date: dateToYYYYMMDD(currentDate),
                });
                newTaskTextInput.value = ''; newTaskPointsInput.value = ''; newTaskMemoInput.value = '';
                addTaskModal.classList.add('hidden'); addTaskModal.classList.remove('flex');
            } catch (e) { showModal('í•  ì¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); console.error(e); }
        };

        const handleAdminAddTask = async () => {
            const selectedUser = adminAddTaskUser.value;
            const commonTaskData = {
                date: adminAddTaskDate.value,
                time: adminAddTaskTime.value,
                text: adminAddTaskText.value.trim(),
                points: parseInt(adminAddTaskPoints.value, 10),
                category: "ê°œì¸í™œë™", // ê¸°ë³¸ê°’
                memo: "ê´€ë¦¬ìê°€ ë“±ë¡í•œ í• ì¼",
                completed: false,
                completedTime: null,
                link: null
            };

            if (!selectedUser || !commonTaskData.date || !commonTaskData.time || !commonTaskData.text || isNaN(commonTaskData.points)) {
                showModal("ëª¨ë“  í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            try {
                if (selectedUser === 'ëª¨ë‘') {
                    const batch = writeBatch(db);
                    const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);

                    const taskForJia = { ...commonTaskData, owner: 'ì§€ì•„' };
                    batch.set(doc(tasksRef), taskForJia);

                    const taskForJihu = { ...commonTaskData, owner: 'ì§€í›„' };
                    batch.set(doc(tasksRef), taskForJihu);

                    await batch.commit();
                    showModal(`ì§€ì•„ì™€ ì§€í›„ ëª¨ë‘ì—ê²Œ í•  ì¼ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.`);
                } else {
                    const task = { ...commonTaskData, owner: selectedUser };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), task);
                    showModal(`${selectedUser}ë‹˜ì—ê²Œ í•  ì¼ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.`);
                }

                adminAddTaskDate.value = dateToYYYYMMDD(new Date());
                adminAddTaskText.value = '';
                adminAddTaskPoints.value = '';

            } catch (e) {
                showModal("í•  ì¼ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                console.error(e);
            }
        };

        const handleToggleTask = async (event, taskId, isChecked) => {
            playSoundAndAnimate(event, isChecked);
            const taskDocRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            try {
                let formattedCompletedTime = null;
                if (isChecked) {
                    const now = new Date();
                    const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    formattedCompletedTime = formatTimeForDisplay(timeString);
                }
                await updateDoc(taskDocRef, { 
                    completed: isChecked, 
                    completedTime: formattedCompletedTime
                });
            } catch (e) { console.error("Error updating task: ", e); }
        };

        const handleDeleteTask = async (taskId) => {
            showConfirm('ì •ë§ë¡œ ì´ í•  ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
                try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId)); } 
                catch (e) { showModal('í•  ì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); console.error(e); }
            }, 'ì‚­ì œ');
        };
        
        const handleEndDay = async () => {
             if (typeof window.Tone !== 'undefined') {
                if (window.Tone.context.state !== 'running') window.Tone.start();
                 const synth = new window.Tone.Synth().toDestination();
                synth.triggerAttackRelease("C4", "8n", window.Tone.now());
                synth.triggerAttackRelease("E4", "8n", window.Tone.now() + 0.2);
                synth.triggerAttackRelease("G4", "8n", window.Tone.now() + 0.4);
            }

            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const todayString = dateToYYYYMMDD(today);
            const tomorrowString = dateToYYYYMMDD(tomorrow);

            const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
            const qToday = query(tasksRef, where("owner", "==", currentAppUser), where("date", "==", todayString));

            try {
                const querySnapshot = await getDocs(qToday);
                let pointsToday = 0;
                const batch = writeBatch(db);

                querySnapshot.forEach(doc => {
                    const task = doc.data();
                    if (task.completed) {
                        pointsToday += task.points;
                    } else {
                        const taskRef = doc.ref;
                        batch.update(taskRef, {
                            date: tomorrowString,
                            points: 0
                        });
                    }
                });

                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                     batch.set(userDocRef, {
                        points: (userDocSnap.data().points || 0) + pointsToday,
                        lastCompletionDate: todayString
                    }, { merge: true });
                }
                
                await batch.commit();

                showModal(`ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ë§ˆê°í–ˆìŠµë‹ˆë‹¤! ${pointsToday} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`);

            } catch (e) {
                showModal('ì˜¤ëŠ˜ í•˜ë£¨ ë§ˆê° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error(e);
            }
        };

        const handlePurchaseAndCreateTask = async (itemId, itemName, itemPoints, selectedDate, selectedTime) => {
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
            try {
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) { showModal("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

                const currentPoints = userDoc.data().points || 0;
                if (currentPoints < itemPoints) { showModal("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
                
                const newPoints = currentPoints - itemPoints;
                const batch = writeBatch(db);
                
                // 1. Update user points
                batch.set(userDocRef, { points: newPoints }, { merge: true });
                
                // 2. Add to purchases log
                const purchasesRef = collection(db, `artifacts/${appId}/public/data/purchases`);
                batch.set(doc(purchasesRef), {
                    userId: currentAppUser,
                    itemName: itemName,
                    points: itemPoints,
                    purchasedAt: serverTimestamp()
                });

                // 3. Add to tasks as a coupon/reward
                const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
                batch.set(doc(tasksRef), {
                    owner: currentAppUser, text: `[ì¿ í°] ${itemName}`, memo: "í¬ì¸íŠ¸ ìƒì ì—ì„œ êµ¬ë§¤í•œ ë³´ìƒ",
                    points: 0, date: selectedDate, time: selectedTime,
                    completed: false, completedTime: null, category: "ë³´ìƒ", link: null,
                });

                await batch.commit();
                showModal(`'${itemName}' ì¿ í°ì„ ${selectedDate}ì— ì‚¬ìš©í•˜ë„ë¡ ë“±ë¡í–ˆìŠµë‹ˆë‹¤!`);

            } catch (e) {
                showModal("êµ¬ë§¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                console.error(e);
            }
        };

         const handleCashExchange = async (itemName) => {
            const amount = parseInt(cashExchangeAmountInput.value, 10);
            if (isNaN(amount) || amount <= 0) {
                showModal("ì˜¬ë°”ë¥¸ í™˜ì „ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
            try {
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) { showModal("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

                const currentPoints = userDoc.data().points || 0;
                if (currentPoints < amount) {
                    showModal("ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
                    return;
                }

                const newPoints = currentPoints - amount;
                const batch = writeBatch(db);

                // 1. Update user points
                batch.set(userDocRef, { points: newPoints }, { merge: true });

                // 2. Add to a new collection for cash exchange requests
                const cashExchangesRef = collection(db, `artifacts/${appId}/public/data/cashExchanges`);
                batch.set(doc(cashExchangesRef), {
                    userId: currentAppUser,
                    itemName: itemName,
                    pointsExchanged: amount,
                    requestedAt: serverTimestamp()
                });

                await batch.commit();
                showModal(`${amount.toLocaleString()}í¬ì¸íŠ¸ í™˜ì „ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (e) {
                showModal("í™˜ì „ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                console.error(e);
            }
        };
        
        const handleAddShopItem = async () => {
            const name = newItemName.value.trim();
            const points = parseInt(newItemPoints.value, 10);
            const isCash = newItemIsCash.checked; 

            if (!name || isNaN(points) || points < 0) {
                showModal("ìƒí’ˆ ì´ë¦„ê³¼ ì˜¬ë°”ë¥¸ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            const itemData = { name, points, type: isCash ? 'cash' : 'coupon' };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/shopItems`), itemData);
                newItemName.value = '';
                newItemPoints.value = '';
                newItemIsCash.checked = false;
            } catch (e) {
                showModal("ìƒí’ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                console.error(e);
            }
        };
        
        const handleDeleteShopItem = async (itemId) => {
            showConfirm("ì •ë§ë¡œ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/shopItems`, itemId));
                } catch (e) {
                    showModal("ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }, "ì‚­ì œ");
        };

        const handleSaveMessages = async () => {
            const jiaMessage = adminMessageJia.value.trim();
            const jihuMessage = adminMessageJihu.value.trim();
            try {
                const jiaDocRef = doc(db, `artifacts/${appId}/public/data/users/ì§€ì•„`);
                const jihuDocRef = doc(db, `artifacts/${appId}/public/data/users/ì§€í›„`);
                await setDoc(jiaDocRef, { adminMessage: jiaMessage }, { merge: true });
                await setDoc(jihuDocRef, { adminMessage: jihuMessage }, { merge: true });
                showModal("ë©”ì‹œì§€ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
            } catch(e) {
                showModal("ë©”ì‹œì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                console.error(e);
            }
        };
        
        const handleCompleteExchange = async (exchangeId) => {
            showConfirm("ì´ í™˜ì „ ìš”ì²­ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª©ë¡ì—ì„œ ì‚­ì œë©ë‹ˆë‹¤.", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/cashExchanges`, exchangeId));
                    showModal("í™˜ì „ ìš”ì²­ì„ ì™„ë£Œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.");
                } catch (e) {
                    showModal("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    console.error(e);
                }
            }, "ì™„ë£Œ", "bg-green-500");
        };

        const handleImportCSV = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const rows = e.target.result.split('\n').slice(1);
                let addedCount = 0;
                for (const row of rows) {
                    if (row.trim() === '') continue;
                    const [date, time, text, memo, pointsStr, status, completedTime, category, link] = row.split(',').map(s => s.trim());
                    const points = parseInt(pointsStr, 10);
                    if (date && time && text && !isNaN(points)) {
                         try {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), {
                                owner: currentAppUser, text, time, memo, points, date,
                                completed: status === 'ì™„ë£Œ', completedTime, category, link,
                            });
                            addedCount++;
                        } catch (err) { console.error("CSV í•­ëª© ì¶”ê°€ ì˜¤ë¥˜: ", err); }
                    }
                }
                showModal(`${addedCount}ê°œì˜ í•  ì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.`);
            };
            reader.readAsText(file, 'utf-8');
            csvFileInput.value = '';
        };
        
        const checkForRolloverTasks = async () => {
            const todayString = dateToYYYYMMDD(new Date());
            const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
            const q = query(tasksRef,
                where("owner", "==", currentAppUser),
                where("completed", "==", false)
            );

            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            
            snapshot.forEach(doc => {
                const task = doc.data();
                if (task.date < todayString) {
                    const taskRef = doc.ref;
                    batch.update(taskRef, {
                        date: todayString,
                        points: 0
                    });
                }
            });

            await batch.commit();
        };

        const seedShopItems = async () => {
             const shopItemsRef = collection(db, `artifacts/${appId}/public/data/shopItems`);
             const snapshot = await getDocs(shopItemsRef);
             if (snapshot.empty) {
                const items = [
                    { name: "ê²Œì„ 1ì‹œê°„", points: 5000, type: 'coupon' },
                    { name: "í•˜ë£¨ë™ì•ˆ ì”ì†Œë¦¬ ê¸ˆì§€", points: 10000, type: 'coupon' },
                    { name: "í˜„ê¸ˆ í™˜ì „", points: 0, type: 'cash' }
                ];
                const batch = writeBatch(db);
                items.forEach(item => {
                    const docRef = doc(shopItemsRef);
                    batch.set(docRef, item);
                });
                await batch.commit();
             }
        };

        const changeDate = (offset) => {
            currentDate.setDate(currentDate.getDate() + offset);
            updateDateUI();
            subscribeToData();
        };

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        settingsBtn.addEventListener('click', () => {
            document.querySelector(`input[name="user-select"][value="${currentAppUser}"]`).checked = true;
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
        });

        cancelSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        });

        saveSettingsBtn.addEventListener('click', () => {
            const selectedUser = document.querySelector('input[name="user-select"]:checked').value;
            localStorage.setItem('fixedAppUser', selectedUser);
            currentAppUser = selectedUser;
            updateUIForUser();
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        });

        profileImg.addEventListener('click', () => {
            if (currentAppUser !== 'ê´€ë¦¬ì') {
                profileUploadInput.click()
            }
        });
        profileUploadInput.addEventListener('change', (e) => handleProfileImageUpload(e, null));
        
        uploadJiaProfileBtn.addEventListener('click', () => { adminProfileUploadTarget = 'ì§€ì•„'; adminProfileUploadInput.click(); });
        uploadJihuProfileBtn.addEventListener('click', () => { adminProfileUploadTarget = 'ì§€í›„'; adminProfileUploadInput.click(); });
        uploadAdminProfileBtn.addEventListener('click', () => { adminProfileUploadTarget = 'ê´€ë¦¬ì'; adminProfileUploadInput.click(); });
        adminProfileUploadInput.addEventListener('change', (e) => handleProfileImageUpload(e, adminProfileUploadTarget));


        uploadHeaderBgBtn.addEventListener('click', () => headerBgUploadInput.click());
        uploadProfileBgBtn.addEventListener('click', () => profileBgUploadInput.click());
        headerBgUploadInput.addEventListener('change', (e) => handleBgImageUpload(e, 'header'));
        profileBgUploadInput.addEventListener('change', (e) => handleBgImageUpload(e, 'profile'));

        prevDayBtn.addEventListener('click', () => changeDate(-1));
        nextDayBtn.addEventListener('click', () => changeDate(1));
        showAddTaskModalBtn.addEventListener('click', () => { addTaskModal.classList.remove('hidden'); addTaskModal.classList.add('flex'); });
        cancelAddTaskBtn.addEventListener('click', () => { addTaskModal.classList.add('hidden'); addTaskModal.classList.remove('flex'); });
        confirmAddTaskBtn.addEventListener('click', handleAddTask);
        endDayBtn.addEventListener('click', handleEndDay);
        importCsvBtn.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', handleImportCSV);
        modalCloseBtn.addEventListener('click', hideModal);
        
        shopBtn.addEventListener('click', showShopPage);
        backToHomeBtn.addEventListener('click', showHomePage);
        
        shopItemsContainer.addEventListener('click', async (e) => {
            const buyBtn = e.target.closest('.buy-item-btn');
            if (buyBtn) {
                const { id, name, points, type } = buyBtn.dataset;
                const itemPoints = Number(points);

                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
                const userDoc = await getDoc(userDocRef);
                const currentPoints = userDoc.exists() ? userDoc.data().points : 0;
                
                if (type === 'cash') {
                    cashExchangeModalTitle.textContent = `'${name}' í™˜ì „`;
                    cashExchangeCurrentPoints.textContent = currentPoints.toLocaleString();
                    confirmCashExchangeBtn.dataset.name = name;
                    cashExchangeAmountInput.value = '';
                    cashExchangeModal.classList.remove('hidden');
                    cashExchangeModal.classList.add('flex');
                } else {
                    if (currentPoints < itemPoints) {
                        showModal("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
                        return;
                    }

                    purchaseModalTitle.textContent = `'${name}' ì¿ í° ì‚¬ìš©`;
                    purchaseDateInput.value = dateToYYYYMMDD(new Date()); 
                    purchaseDateInput.min = dateToYYYYMMDD(new Date()); 
                    
                    confirmPurchaseBtn.dataset.id = id;
                    confirmPurchaseBtn.dataset.name = name;
                    confirmPurchaseBtn.dataset.points = points;

                    purchaseModal.classList.remove('hidden');
                    purchaseModal.classList.add('flex');
                }
            }
        });
        
        cancelPurchaseBtn.addEventListener('click', () => {
            purchaseModal.classList.add('hidden');
            purchaseModal.classList.remove('flex');
        });

        confirmPurchaseBtn.addEventListener('click', () => {
            const { id, name, points } = confirmPurchaseBtn.dataset;
            const selectedDate = purchaseDateInput.value;
            const selectedTime = purchaseTimeInput.value;

            if (!selectedDate) {
                showModal("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            handlePurchaseAndCreateTask(id, name, Number(points), selectedDate, selectedTime);
            purchaseModal.classList.add('hidden');
            purchaseModal.classList.remove('flex');
        });

        cancelCashExchangeBtn.addEventListener('click', () => {
            cashExchangeModal.classList.add('hidden');
            cashExchangeModal.classList.remove('flex');
        });

        confirmCashExchangeBtn.addEventListener('click', () => {
            const { name } = confirmCashExchangeBtn.dataset;
            handleCashExchange(name);
            cashExchangeModal.classList.add('hidden');
            cashExchangeModal.classList.remove('flex');
        });
        
        addItemBtn.addEventListener('click', handleAddShopItem);
        adminShopItemsContainer.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-item-btn');
            if (deleteBtn) {
                handleDeleteShopItem(deleteBtn.dataset.id);
            }
        });
        
        saveMessagesBtn.addEventListener('click', handleSaveMessages);
        adminAddTaskBtn.addEventListener('click', handleAdminAddTask);

        confirmCancelBtn.addEventListener('click', () => { confirmCallback = null; confirmModal.classList.add('hidden'); confirmModal.classList.remove('flex'); });
        confirmOkBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
            confirmModal.classList.add('hidden');
            confirmModal.classList.remove('flex');
        });

        taskListEl.addEventListener('change', (e) => { 
            if (e.target.type === 'checkbox') handleToggleTask(e, e.target.dataset.id, e.target.checked);
        });
        taskListEl.addEventListener('click', (e) => { 
            const deleteBtn = e.target.closest('.delete-task-btn'); 
            if (deleteBtn) handleDeleteTask(deleteBtn.dataset.id);
            
            const postponeBtn = e.target.closest('.postpone-task-btn');
            if (postponeBtn) handlePostponeTask(postponeBtn.dataset.id, postponeBtn.dataset.time);
        });

        adminPage.addEventListener('click', (e) => {
            const completeBtn = e.target.closest('.complete-exchange-btn');
            if(completeBtn) {
                handleCompleteExchange(completeBtn.dataset.id);
            }
        });
        
        generateQuoteBtn.addEventListener('click', async () => {
            const prompt = `${currentAppUser}ë¥¼ ìœ„í•œ ì§§ê³  í˜ì´ ë˜ëŠ” ë‹¤ì§ í•œë§ˆë””ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“¤ì–´ì¤˜.`;
            const newQuote = await callGeminiAPI(prompt);
            if (newQuote) {
                userQuoteDisplay.textContent = newQuote;
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
                await setDoc(userDocRef, { quote: newQuote }, { merge: true });
            }
        });

        userSpeechBubble.addEventListener('click', () => {
            if (currentAppUser !== 'ê´€ë¦¬ì') {
                editQuoteInput.value = userQuoteDisplay.textContent;
                quoteEditModal.classList.remove('hidden');
                quoteEditModal.classList.add('flex');
            }
        });

        cancelEditQuoteBtn.addEventListener('click', () => {
            quoteEditModal.classList.add('hidden');
            quoteEditModal.classList.remove('flex');
        });

        saveEditQuoteBtn.addEventListener('click', async () => {
            const newQuote = editQuoteInput.value.trim();
            if (newQuote) {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
                await setDoc(userDocRef, { quote: newQuote }, { merge: true });
                quoteEditModal.classList.add('hidden');
                quoteEditModal.classList.remove('flex');
            }
        });

        aiTaskRecommendBtn.addEventListener('click', async () => {
            const category = newTaskCategoryInput.value;
            const prompt = `ì˜¤ëŠ˜ ${currentAppUser}ê°€ í•  ë§Œí•œ ${category} ê´€ë ¨ í™œë™ í•œ ê°€ì§€ë¥¼ ì¶”ì²œí•´ì¤˜. í• ì¼ ì œëª©ë§Œ ê°„ê²°í•˜ê²Œ.`;
            const suggestedTask = await callGeminiAPI(prompt);
            if (suggestedTask) {
                newTaskTextInput.value = suggestedTask.replace(/["'.]/g, ''); // Remove quotes and periods
            }
        });


        // --- ì•± ì´ˆê¸°í™” ---
        const setupApp = () => {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');

            populateTimeSelect(newTaskTimeInput);
            populateTimeSelect(purchaseTimeInput);
            populateTimeSelect(adminAddTaskTime);
            adminAddTaskDate.value = dateToYYYYMMDD(new Date());

            currentAppUser = localStorage.getItem('fixedAppUser') || 'ì§€ì•„';
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    
                    if (currentAppUser !== 'ê´€ë¦¬ì') {
                        const todayString = dateToYYYYMMDD(new Date());
                        const lastVisit = localStorage.getItem(`lastVisitDate_${currentAppUser}`);
                        if (lastVisit !== todayString) {
                            await checkForRolloverTasks();
                            localStorage.setItem(`lastVisitDate_${currentAppUser}`, todayString);
                        }
                    }

                    await seedShopItems();
                    updateDateUI();
                    updateUIForUser();
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                } else {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' && __initial_auth_token;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Authentication failed: ", e);
                         loadingOverlay.innerHTML = `<div class="text-red-500 text-center">ì¸ì¦ ì‹¤íŒ¨.<br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>`;
                    }
                }
            });
        };

        setupApp();

    </script>
</body>
</html>

