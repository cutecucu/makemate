<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘 할 일</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        html {
            font-size: 14px; /* 기본 폰트 크기를 줄여 전체 UI를 작게 만듭니다. */
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        @keyframes float-up {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
        }
        .emoji-animation {
            position: absolute;
            z-index: 100;
            animation: float-up 1s ease-out forwards;
            pointer-events: none; /* Make it unclickable */
        }
        .admin-header-bg {
            /* 관리자 모드일 때 기본 배경 이미지 (업로드된 이미지가 없을 경우) */
            background-image: url('https://placehold.co/800x300/6d28d9/ffffff?text=Admin+Mode');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-md mx-auto h-screen bg-white shadow-lg flex flex-col relative overflow-hidden transition-all duration-300">
        <!-- 헤더 -->
        <header id="app-header" class="bg-gradient-to-br from-purple-500 to-pink-500 text-white py-4 px-4 shadow-lg z-20">
            <div class="flex justify-between items-center">
                <h1 id="main-title" class="text-2xl font-bold"><span id="header-username"></span><span id="header-title-text"> 오늘 할 일</span></h1>
                <div id="header-icons" class="flex items-center space-x-2">
                    <input type="file" id="csv-file" accept=".csv" class="hidden">
                    <button id="import-csv-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                    </button>
                    <button id="shop-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </button>
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
                <div id="header-back-btn-container" class="hidden">
                     <button id="back-to-home-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="points-display-header" class="text-right mt-2 text-lg">
                총 포인트: <span class="total-points-display font-bold">0</span>점
            </div>

            <div id="profile-and-date-section">
                 <div id="profile-section" class="relative h-48 mt-2">
                    <!-- User Part (Left, slightly higher) -->
                    <div class="absolute top-4 left-0 flex items-center w-3/4 z-10">
                        <div class="relative group flex-shrink-0">
                            <img id="profile-img" src="" alt="Profile Picture" class="w-24 h-24 object-cover cursor-pointer transform -rotate-6 hover:rotate-0 hover:scale-110 transition-transform duration-300 shadow-lg">
                        </div>
                        <div id="user-speech-bubble" class="relative bg-white text-gray-800 p-3 -ml-4 rounded-lg shadow-lg cursor-pointer">
                            <div class="flex items-center justify-center">
                                <p id="user-quote-display" class="text-sm font-bold"></p>
                                <button id="generate-quote-btn" class="ml-2 text-purple-400 hover:text-purple-600">✨</button>
                            </div>
                            <div class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 w-0 h-0 border-t-[8px] border-t-transparent border-b-[8px] border-b-transparent border-r-[8px] border-r-white"></div>
                        </div>
                    </div>
                    <!-- Admin Part (Right, slightly lower) -->
                    <div class="absolute bottom-4 right-0 flex items-center w-3/4 justify-end">
                        <div class="relative bg-purple-200 text-purple-900 p-3 -mr-4 rounded-lg shadow-lg z-10">
                            <p id="admin-message-display" class="text-sm"></p>
                             <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 w-0 h-0 border-t-[8px] border-t-transparent border-b-[8px] border-b-transparent border-l-[8px] border-l-purple-200"></div>
                        </div>
                        <div class="flex-shrink-0 z-0">
                            <img id="admin-profile-img" src="" alt="Admin Picture" class="w-24 h-24 object-cover transform rotate-6 shadow-lg">
                        </div>
                    </div>
                </div>
                
                <div id="date-navigation" class="flex justify-between items-center text-white mt-1">
                    <button id="prev-day-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 id="current-date-display" class="text-xl font-bold"></h2>
                    <button id="next-day-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- 할일 목록 (타임라인) -->
        <main id="task-list" class="flex-1 overflow-y-auto py-4 px-4 sm:px-6 no-scrollbar bg-gray-50 relative">
            <!-- 타임라인이 여기에 동적으로 생성됩니다. -->
        </main>
        
        <!-- 포인트 상점 -->
        <main id="shop-page" class="hidden flex-1 overflow-y-auto py-4 px-4 sm:px-6 no-scrollbar bg-gray-50 relative">
             <div class="bg-white p-4 rounded-lg shadow-md mb-4 sticky top-0 z-10">
                <p class="text-lg text-center">
                    <span id="shop-user-name" class="font-bold"></span>님의 현재 포인트: <span class="total-points-display font-bold text-pink-600">0</span>점
                </p>
             </div>
             <div id="shop-items-container" class="space-y-3">
                <!-- 상점 아이템이 여기에 동적으로 생성됩니다. -->
             </div>
        </main>

        <!-- 관리자 페이지 -->
        <main id="admin-page" class="hidden flex-1 overflow-y-auto py-4 px-4 sm:px-6 no-scrollbar bg-gray-50 relative">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold mb-3">페이지 디자인</h3>
                        <div class="space-y-4">
                             <!-- Message Section -->
                            <div class="space-y-2 border-b pb-4">
                                <h4 class="font-bold text-md">사용자에게 메시지 보내기</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="admin-message-jia" class="block text-sm font-medium text-gray-700">지아에게:</label>
                                        <input type="text" id="admin-message-jia" class="w-full border rounded p-2 focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label for="admin-message-jihu" class="block text-sm font-medium text-gray-700">지후에게:</label>
                                        <input type="text" id="admin-message-jihu" class="w-full border rounded p-2 focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                                <button id="save-messages-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2">메시지 저장</button>
                            </div>

                             <!-- Background Image Section -->
                            <div class="space-y-4 border-b pb-4">
                                <h4 class="font-bold text-md">배경 이미지 등록</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">타이틀 배경 (헤더)</label>
                                        <p class="text-xs text-gray-500 mb-2">권장 사이즈: 800 x 300 픽셀</p>
                                        <button id="upload-header-bg-btn" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">이미지 업로드</button>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">프로필 배경</label>
                                        <p class="text-xs text-gray-500 mb-2">권장 사이즈: 600 x 200 픽셀</p>
                                        <button id="upload-profile-bg-btn" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">이미지 업로드</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profile Picture Management -->
                            <div class="space-y-4">
                                <h4 class="font-bold text-md">프로필 사진 관리</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">지아 프로필</label>
                                        <button id="upload-jia-profile-btn" class="mt-2 w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">사진 올리기</button>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">지후 프로필</label>
                                        <button id="upload-jihu-profile-btn" class="mt-2 w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">사진 올리기</button>
                                    </div>
                                     <div>
                                        <label class="block text-sm font-medium text-gray-700">관리자 프로필</label>
                                        <button id="upload-admin-profile-btn" class="mt-2 w-full bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">사진 올리기</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3">사용자 할 일 등록</h3>
                    <div class="space-y-2">
                         <select id="admin-add-task-user" class="w-full border rounded p-2">
                            <option value="지아">지아에게 등록</option>
                            <option value="지후">지후에게 등록</option>
                            <option value="모두">모두에게 등록</option>
                        </select>
                        <input type="date" id="admin-add-task-date" class="w-full border rounded p-2">
                        <select id="admin-add-task-time" class="w-full border rounded p-2"></select>
                        <input type="text" id="admin-add-task-text" placeholder="할 일 내용" class="w-full border rounded p-2">
                        <input type="number" id="admin-add-task-points" placeholder="포인트" class="w-full border rounded p-2">
                        <button id="admin-add-task-btn" class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600 mt-2">할 일 등록</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3">상점 아이템 관리</h3>
                    <div class="flex items-center gap-2 mb-3">
                        <input type="text" id="new-item-name" placeholder="상품 이름" class="flex-grow border rounded p-2 focus:ring-2 focus:ring-purple-500">
                        <input type="number" id="new-item-points" placeholder="포인트" class="w-24 border rounded p-2 text-center focus:ring-2 focus:ring-purple-500">
                        <button id="add-item-btn" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">추가</button>
                    </div>
                     <div class="flex items-center mb-3">
                        <input type="checkbox" id="new-item-is-cash" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <label for="new-item-is-cash" class="ml-2 block text-sm text-gray-900">현금 환전 쿠폰</label>
                    </div>
                    <div id="admin-shop-items-container" class="space-y-3 border-t pt-3">
                        <!-- 관리자용 상점 아이템 목록 -->
                    </div>
                </div>

                 <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold mb-3">오늘 완료한 할일 보기</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-md text-pink-600">지아</h4>
                                <div id="admin-completed-jia" class="space-y-2 mt-2 border-t pt-2"></div>
                            </div>
                             <div class="">
                                <h4 class="font-bold text-md text-blue-600">지후</h4>
                                <div id="admin-completed-jihu" class="space-y-2 mt-2 border-t pt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3">현금 환전 요청 목록</h3>
                    <div id="admin-cash-exchanges-container" class="space-y-3 border-t pt-3">
                        <!-- 환전 요청 목록 -->
                    </div>
                </div>
            </div>
        </main>


        <!-- 하단 메뉴 -->
        <footer class="p-4 bg-white border-t border-gray-200 z-10">
             <div id="home-footer-buttons" class="flex items-center gap-4">
                <button id="end-day-btn" class="flex-grow bg-green-500 text-white font-bold py-3 rounded-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">오늘 하루 끝</button>
                <button id="show-add-task-modal-btn" class="flex-shrink-0 bg-purple-500 text-white w-14 h-14 rounded-full shadow-lg hover:bg-purple-600 flex items-center justify-center transition-transform transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
            </div>
        </footer>
    </div>
    
    <input type="file" id="profile-upload-input" class="hidden" accept="image/*">
    <input type="file" id="header-bg-upload-input" class="hidden" accept="image/*">
    <input type="file" id="profile-bg-upload-input" class="hidden" accept="image/*">
    <input type="file" id="admin-profile-upload-input" class="hidden" accept="image/*">
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex items-center justify-center z-[100]">
        <div class="text-purple-600 text-xl font-bold">로딩 중...</div>
    </div>


    <!-- 일반 메시지 모달 -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <p id="modal-message" class="text-lg mb-4"></p>
            <button id="modal-close-btn" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">확인</button>
        </div>
    </div>
    
    <!-- 삭제/구매 확인 모달 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <p id="confirm-message" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">취소</button>
                <button id="confirm-ok-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">확인</button>
            </div>
        </div>
    </div>

     <!-- 쿠폰 사용(구매) 모달 -->
    <div id="purchase-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 id="purchase-modal-title" class="text-xl font-bold mb-4"></h3>
            <p class="text-gray-600 mb-4">쿠폰을 사용할 날짜와 시간을 선택해주세요.</p>
            <div class="space-y-3">
                <input type="date" id="purchase-date" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
                <select id="purchase-time" class="border rounded-lg p-2 w-full text-gray-700 bg-white"></select>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-purchase-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">취소</button>
                <button id="confirm-purchase-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">사용하기</button>
            </div>
        </div>
    </div>
    
    <!-- 현금 환전 모달 -->
    <div id="cash-exchange-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 id="cash-exchange-modal-title" class="text-xl font-bold mb-4">현금 환전</h3>
            <p class="text-gray-600 mb-2">환전할 포인트 금액을 입력해주세요.</p>
            <p class="text-sm text-gray-500 mb-4">현재 보유 포인트: <span id="cash-exchange-current-points" class="font-bold">0</span>점</p>
            <div class="space-y-3">
                <input type="number" id="cash-exchange-amount" placeholder="환전할 포인트" class="w-full border rounded-lg p-2 text-center focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-cash-exchange-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">취소</button>
                <button id="confirm-cash-exchange-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">환전하기</button>
            </div>
        </div>
    </div>

    <!-- 사용자 다짐 수정 모달 -->
    <div id="quote-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 class="text-xl font-bold mb-4">오늘의 다짐 수정</h3>
            <input type="text" id="edit-quote-input" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-edit-quote-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">취소</button>
                <button id="save-edit-quote-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">저장</button>
            </div>
        </div>
    </div>


    <!-- 사용자 설정 모달 -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 class="text-xl font-bold mb-4">사용자 설정</h3>
            <p class="text-gray-600 mb-4">앱을 사용할 사용자를 선택해주세요. 이 설정은 기기에 저장됩니다.</p>
            <div class="space-y-2">
                <label for="user-jia" class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-400">
                    <input type="radio" id="user-jia" name="user-select" value="지아" class="h-4 w-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                    <span class="ml-3 text-lg font-medium">지아</span>
                </label>
                <label for="user-jihu" class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-400">
                    <input type="radio" id="user-jihu" name="user-select" value="지후" class="h-4 w-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                    <span class="ml-3 text-lg font-medium">지후</span>
                </label>
                 <label for="user-admin" class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-400">
                    <input type="radio" id="user-admin" name="user-select" value="관리자" class="h-4 w-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                    <span class="ml-3 text-lg font-medium">관리자</span>
                </label>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-settings-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">취소</button>
                <button id="save-settings-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">저장</button>
            </div>
        </div>
    </div>


    <!-- 할일 추가 모달 -->
    <div id="add-task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 id="add-task-modal-title" class="text-xl font-bold mb-4">새로운 할 일 추가</h3>
             <button id="ai-task-recommend-btn" class="w-full bg-purple-100 text-purple-700 font-semibold py-2 px-4 rounded-lg hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition mb-4">
                ✨ AI로 할 일 추천받기
            </button>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                     <select id="new-task-time" class="border rounded-lg p-2 w-full text-gray-700 bg-white"></select>
                     <select id="new-task-category" class="border rounded-lg p-2 w-full text-gray-700 bg-white">
                        <option value="학습">🔵 학습</option>
                        <option value="생활습관">🟢 생활습관</option>
                        <option value="개인활동">🟡 개인활동</option>
                        <option value="보상">🟣 보상</option>
                     </select>
                </div>
                <input type="text" id="new-task-text" placeholder="할 일 내용" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
                <input type="text" id="new-task-memo" placeholder="메모 (선택 사항)" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500">
                <input type="number" id="new-task-points" placeholder="포인트" class="w-full border rounded-lg p-2 text-center focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-add-task-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">취소</button>
                <button id="confirm-add-task-btn" class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600">추가</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, onSnapshot, query, where, updateDoc, deleteDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 설정 ---
        // 중요: GitHub 등 외부에서 사용하려면, 본인의 Firebase 프로젝트 설정으로 이 부분을 교체해야 합니다!
        // 1. Firebase 콘솔(https://console.firebase.google.com/)에서 프로젝트를 만드세요.
        // 2. 프로젝트 설정 > 일반 탭에서 '웹 앱'을 등록하고 firebaseConfig 값을 복사하세요.
        // 3. Firestore Database와 Authentication(익명 로그인 활성화)을 활성화하세요.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyC7hwYS_Ww9q7_9kHewjlKPDmXzJPB1Hko",
                authDomain: "todolist-b9581.firebaseapp.com",
                projectId: "todolist-b9581",
                storageBucket: "todolist-b9581.firebasestorage.app",
                messagingSenderId: "184765484937",
                appId: "1:184765484937:web:15328e8f30d6b7f5cbdb58",
                measurementId: "G-2KS0DCH3NS"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        try {
            app = initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase 초기화 실패. 설정 값을 확인해주세요.", e);
            loadingOverlay.innerHTML = `<div class="text-red-500 text-center">Firebase 연결 실패.<br>설정 값을 확인해주세요.</div>`;
        }
        
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- 상태 변수 ---
        let currentUser = null; 
        let currentAppUser = '지아'; 
        let tasksUnsubscribe = null;
        let userUnsubscribe = null;
        let shopUnsubscribe = null;
        let adminTasksUnsubscribe = null;
        let adminCashUnsubscribe = null;
        let designUnsubscribe = null;
        let confirmCallback = null;
        let synth = null;
        let currentDate = new Date();
        let adminProfileUploadTarget = null;


        const userProfiles = {
            '지아': { name: '지아', img: 'https://placehold.co/100x100/f871b1/ffffff?text=Jia', quote: '오늘도 화이팅! ✨' },
            '지후': { name: '지후', img: 'https://placehold.co/100x100/60a5fa/ffffff?text=Jihu', quote: '최고의 하루를 만들자! 🚀' },
            '관리자': { name: '관리자', img: 'https://placehold.co/100x100/a855f7/ffffff?text=Admin', quote: '상점 및 사용자 관리' }
        };

        const categoryColors = {
            '학습':     { border: 'border-l-blue-500', timeBg: 'bg-blue-500' },
            '생활습관': { border: 'border-l-green-500', timeBg: 'bg-green-500' },
            '개인활동': { border: 'border-l-yellow-500', timeBg: 'bg-yellow-500' },
            '보상':     { border: 'border-l-purple-500', timeBg: 'bg-purple-500' },
            'default':  { border: 'border-l-gray-300', timeBg: 'bg-gray-400' }
        };

        // --- DOM 요소 ---
        const appEl = document.getElementById('app');
        const appHeader = document.getElementById('app-header');
        const mainTitle = document.getElementById('main-title'), headerUsername = document.getElementById('header-username'), headerTitleText = document.getElementById('header-title-text'), headerIcons = document.getElementById('header-icons'), headerBackBtnContainer = document.getElementById('header-back-btn-container'), backToHomeBtn = document.getElementById('back-to-home-btn');
        const profileAndDateSection = document.getElementById('profile-and-date-section');
        const prevDayBtn = document.getElementById('prev-day-btn'), nextDayBtn = document.getElementById('next-day-btn'), currentDateDisplay = document.getElementById('current-date-display');
        const profileImg = document.getElementById('profile-img'), userQuoteDisplay = document.getElementById('user-quote-display'), adminMessageDisplay = document.getElementById('admin-message-display'), totalPointsDisplays = document.querySelectorAll('.total-points-display'), taskListEl = document.getElementById('task-list'), endDayBtn = document.getElementById('end-day-btn'), importCsvBtn = document.getElementById('import-csv-btn'), csvFileInput = document.getElementById('csv-file');
        const messageModal = document.getElementById('message-modal'), modalMessage = document.getElementById('modal-message'), modalCloseBtn = document.getElementById('modal-close-btn');
        const confirmModal = document.getElementById('confirm-modal'), confirmMessage = document.getElementById('confirm-message'), confirmCancelBtn = document.getElementById('confirm-cancel-btn'), confirmOkBtn = document.getElementById('confirm-ok-btn');
        const addTaskModal = document.getElementById('add-task-modal'), showAddTaskModalBtn = document.getElementById('show-add-task-modal-btn'), cancelAddTaskBtn = document.getElementById('cancel-add-task-btn'), confirmAddTaskBtn = document.getElementById('confirm-add-task-btn'), newTaskTimeInput = document.getElementById('new-task-time'), newTaskCategoryInput = document.getElementById('new-task-category'), newTaskTextInput = document.getElementById('new-task-text'), newTaskMemoInput = document.getElementById('new-task-memo'), newTaskPointsInput = document.getElementById('new-task-points'), addTaskModalTitle = document.getElementById('add-task-modal-title');
        const profileUploadInput = document.getElementById('profile-upload-input'), headerBgUploadInput = document.getElementById('header-bg-upload-input'), profileBgUploadInput = document.getElementById('profile-bg-upload-input'), adminProfileUploadInput = document.getElementById('admin-profile-upload-input');
        const settingsBtn = document.getElementById('settings-btn'), settingsModal = document.getElementById('settings-modal'), cancelSettingsBtn = document.getElementById('cancel-settings-btn'), saveSettingsBtn = document.getElementById('save-settings-btn');
        const shopBtn = document.getElementById('shop-btn'), shopPage = document.getElementById('shop-page'), shopItemsContainer = document.getElementById('shop-items-container'), shopUserName = document.getElementById('shop-user-name'), homeFooterButtons = document.getElementById('home-footer-buttons');
        const adminPage = document.getElementById('admin-page'), adminShopItemsContainer = document.getElementById('admin-shop-items-container'), newItemName = document.getElementById('new-item-name'), newItemPoints = document.getElementById('new-item-points'), addItemBtn = document.getElementById('add-item-btn');
        const purchaseModal = document.getElementById('purchase-modal'), purchaseModalTitle = document.getElementById('purchase-modal-title'), purchaseDateInput = document.getElementById('purchase-date'), purchaseTimeInput = document.getElementById('purchase-time'), cancelPurchaseBtn = document.getElementById('cancel-purchase-btn'), confirmPurchaseBtn = document.getElementById('confirm-purchase-btn');
        const adminMessageJia = document.getElementById('admin-message-jia'), adminMessageJihu = document.getElementById('admin-message-jihu'), saveMessagesBtn = document.getElementById('save-messages-btn');
        const adminCompletedJia = document.getElementById('admin-completed-jia'), adminCompletedJihu = document.getElementById('admin-completed-jihu');
        const adminAddTaskUser = document.getElementById('admin-add-task-user'), adminAddTaskDate = document.getElementById('admin-add-task-date'), adminAddTaskTime = document.getElementById('admin-add-task-time'), adminAddTaskText = document.getElementById('admin-add-task-text'), adminAddTaskPoints = document.getElementById('admin-add-task-points'), adminAddTaskBtn = document.getElementById('admin-add-task-btn');
        const cashExchangeModal = document.getElementById('cash-exchange-modal'), cashExchangeModalTitle = document.getElementById('cash-exchange-modal-title'), cashExchangeCurrentPoints = document.getElementById('cash-exchange-current-points'), cashExchangeAmountInput = document.getElementById('cash-exchange-amount'), cancelCashExchangeBtn = document.getElementById('cancel-cash-exchange-btn'), confirmCashExchangeBtn = document.getElementById('confirm-cash-exchange-btn');
        const newItemIsCash = document.getElementById('new-item-is-cash');
        const adminCashExchangesContainer = document.getElementById('admin-cash-exchanges-container');
        const uploadHeaderBgBtn = document.getElementById('upload-header-bg-btn'), uploadProfileBgBtn = document.getElementById('upload-profile-bg-btn');
        const adminProfileImg = document.getElementById('admin-profile-img');
        const generateQuoteBtn = document.getElementById('generate-quote-btn');
        const aiTaskRecommendBtn = document.getElementById('ai-task-recommend-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const quoteEditModal = document.getElementById('quote-edit-modal'), editQuoteInput = document.getElementById('edit-quote-input'), cancelEditQuoteBtn = document.getElementById('cancel-edit-quote-btn'), saveEditQuoteBtn = document.getElementById('save-edit-quote-btn');
        const userSpeechBubble = document.getElementById('user-speech-bubble');
        const pointsDisplayHeader = document.getElementById('points-display-header');
        const uploadJiaProfileBtn = document.getElementById('upload-jia-profile-btn'), uploadJihuProfileBtn = document.getElementById('upload-jihu-profile-btn'), uploadAdminProfileBtn = document.getElementById('upload-admin-profile-btn');

        // --- 유틸리티 함수 ---
        const dateToYYYYMMDD = (d) => {
            const date = new Date(d);
            // Use local date parts to avoid timezone shift from toISOString()
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const formatTimeForDisplay = (timeString) => {
            if (!timeString) return '';
            const [h, m] = timeString.split(':').map(Number);
            const minutes = String(m).padStart(2, '0');

            if (h === 0) {
                return `오전 12:${minutes}`;
            } else if (h < 12) {
                return `오전 ${String(h).padStart(2, '0')}:${minutes}`;
            } else if (h === 12) {
                return `오후 12:${minutes}`;
            } else {
                return `오후 ${String(h - 12).padStart(2, '0')}:${minutes}`;
            }
        };

        const getRelativeDateInfo = (d) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(d);
            targetDate.setHours(0, 0, 0, 0);
            
            const diffTime = targetDate - today;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return { label: '오늘', isToday: true, isPast: false };
            if (diffDays === -1) return { label: '어제', isToday: false, isPast: true };
            if (diffDays === 1) return { label: '내일', isToday: false, isPast: false };
            
            const formattedDate = `${targetDate.getMonth() + 1}월 ${targetDate.getDate()}일`;
            return { label: formattedDate, isToday: false, isPast: diffDays < 0 };
        };

        const showModal = (message) => { modalMessage.textContent = message; messageModal.classList.remove('hidden'); messageModal.classList.add('flex'); };
        const hideModal = () => { messageModal.classList.add('hidden'); messageModal.classList.remove('flex'); };
        const showConfirm = (message, onConfirm, okText = '확인', okColor = 'bg-red-500') => {
            confirmMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmOkBtn.textContent = okText;
            confirmOkBtn.className = `px-6 py-2 rounded-lg text-white ${okColor} hover:opacity-90`;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        };
        const populateTimeSelect = (selectElement) => {
            selectElement.innerHTML = '';
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const displayText = formatTimeForDisplay(timeValue);
                    selectElement.add(new Option(displayText, timeValue));
                }
            }
        };

        // --- 페이지 전환 ---
        const showAdminPage = () => {
            appEl.classList.remove('max-w-md');
            appEl.classList.add('md:max-w-6xl');
            appHeader.classList.add('admin-header-bg');
            mainTitle.innerHTML = `<span id="header-title-text">관리자 페이지</span>`;
            headerIcons.classList.remove('hidden'); // 설정 버튼을 위해 표시
            headerBackBtnContainer.classList.add('hidden');
            profileAndDateSection.classList.add('hidden');
            pointsDisplayHeader.classList.add('hidden');
            taskListEl.classList.add('hidden');
            shopPage.classList.add('hidden');
            adminPage.classList.remove('hidden');
            homeFooterButtons.classList.add('hidden');
        };

        const showShopPage = () => {
            appEl.classList.add('max-w-md');
            appEl.classList.remove('md:max-w-6xl');
            appHeader.classList.remove('admin-header-bg');
            mainTitle.textContent = "포인트 상점";
            headerIcons.classList.add('hidden');
            headerBackBtnContainer.classList.remove('hidden');
            profileAndDateSection.classList.add('hidden');
            pointsDisplayHeader.classList.remove('hidden');
            taskListEl.classList.add('hidden');
            shopPage.classList.remove('hidden');
            adminPage.classList.add('hidden');
            homeFooterButtons.classList.add('hidden');
        };
        
        const showHomePage = () => {
            appEl.classList.add('max-w-md');
            appEl.classList.remove('md:max-w-6xl');
            appHeader.classList.remove('admin-header-bg');
            const userText = currentAppUser === '관리자' ? '' : `${currentAppUser}의 `;
            mainTitle.innerHTML = `<span id="header-username">${userText}</span><span id="header-title-text"> 오늘 할 일</span>`;
            headerIcons.classList.remove('hidden');
            headerBackBtnContainer.classList.add('hidden');
            profileAndDateSection.classList.remove('hidden');
            pointsDisplayHeader.classList.remove('hidden');
            taskListEl.classList.remove('hidden');
            shopPage.classList.add('hidden');
            adminPage.classList.add('hidden');
            homeFooterButtons.classList.remove('hidden');
        };

        // --- 타임라인 UI 렌더링 ---
        const createTaskCard = (task, isReadOnly) => {
            const taskEl = document.createElement('div');
            const categoryStyle = categoryColors[task.category] || categoryColors.default;
            taskEl.className = `flex-1 flex items-center p-3 shadow-sm transition-all duration-300 bg-white border-l-4 ${task.completed ? 'bg-green-50' : ''} ${categoryStyle.border}`;
            
            const linkHTML = task.link ? `
                <a href="${task.link.startsWith('http') ? task.link : '//' + task.link}" target="_blank" class="text-blue-500 hover:text-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0m-2.828-2.828a2 2 0 012.828 0l3 3a2 2 0 11-2.828 2.828m-3 3a2 2 0 11-2.828-2.828l3-3a2 2 0 012.828 0" clip-rule="evenodd" /></svg>
                </a>` : '';
            
            const postponeBtnHTML = `
                <button data-id="${task.id}" data-time="${task.time}" class="postpone-task-btn text-blue-400 hover:text-blue-600 ${isReadOnly ? 'hidden' : ''}">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                   </svg>
                </button>`;

            taskEl.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-lg ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</p>
                    <div class="mt-1 space-y-1">
                        ${task.memo ? `<p class="text-sm text-gray-500 ${task.completed ? 'line-through' : ''}">${task.memo}</p>` : ''}
                        ${task.completed && task.completedTime ? `<p class="text-xs text-green-600 font-medium">✅ 완료: ${task.completedTime}</p>` : ''}
                    </div>
                </div>
                <div class="text-right flex-shrink-0 flex flex-col items-center space-y-1 pl-2">
                    <span class="font-bold text-pink-600 text-lg">${task.points} P</span>
                    <div class="flex items-center space-x-2 h-5">
                      ${postponeBtnHTML}
                      ${linkHTML}
                      <button data-id="${task.id}" class="delete-task-btn text-red-400 hover:text-red-600 ${isReadOnly ? 'hidden' : ''}">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                      </button>
                    </div>
                </div>
            `;
            return taskEl;
        };
        
        const renderTasks = (tasks, isReadOnly) => {
            taskListEl.innerHTML = '';
            const tasksByTime = tasks.reduce((acc, task) => { (acc[task.time] = acc[task.time] || []).push(task); return acc; }, {});
            const sortedTimes = Object.keys(tasksByTime).sort();

            if (sortedTimes.length === 0) {
                taskListEl.innerHTML = `<p class="text-center text-gray-500 mt-10">${getRelativeDateInfo(currentDate).label} 할 일이 없습니다.</p>`;
            } else {
                for (const timeString of sortedTimes) {
                    const slotEl = document.createElement('div');
                    slotEl.className = 'flex';
                    slotEl.dataset.time = timeString;

                    const tasksForThisTime = tasksByTime[timeString];
                    
                    const timelineHTML = `<div class="w-8 text-center flex-shrink-0 relative pt-1"><div class="absolute top-8 left-1/2 w-px h-[calc(100%-2rem)] border-l-2 border-dotted border-gray-300 -z-10"></div></div>`;
                    const cardsContainer = document.createElement('div');
                    cardsContainer.className = "w-full";

                    tasksForThisTime.sort((a,b) => a.text.localeCompare(b.text)).forEach((task, index) => {
                        const taskWrapper = document.createElement('div');
                        taskWrapper.className = "flex items-start mb-2";
                        const displayTime = formatTimeForDisplay(timeString);

                        const timeAndCheckHTML = `
                            <div class="w-8 flex-shrink-0 flex flex-col items-center pt-1">
                                ${index === 0 ? `<div class="px-2 py-0.5 inline-block text-white text-xs font-bold time-bg ${ (categoryColors[task.category] || categoryColors.default).timeBg } mb-2">${displayTime}</div>` : '<div class="h-8"></div>'}
                                <input type="checkbox" data-id="${task.id}" class="h-6 w-6 rounded-full border-gray-300 text-purple-600 focus:ring-purple-500 cursor-pointer" ${task.completed ? 'checked' : ''} ${isReadOnly ? 'disabled' : ''}>
                            </div>`;
                        
                        taskWrapper.innerHTML = timeAndCheckHTML;
                        taskWrapper.appendChild(createTaskCard(task, isReadOnly));
                        cardsContainer.appendChild(taskWrapper);
                    });

                    slotEl.innerHTML = timelineHTML;
                    slotEl.appendChild(cardsContainer);
                    taskListEl.appendChild(slotEl);
                }
            }
        };

        const renderAdminCompletedTasks = (tasks) => {
            const jiaContainer = adminCompletedJia;
            const jihuContainer = adminCompletedJihu;
            jiaContainer.innerHTML = '';
            jihuContainer.innerHTML = '';

            const jiaTasks = tasks.filter(t => t.owner === '지아').sort((a,b) => a.time.localeCompare(b.time));
            const jihuTasks = tasks.filter(t => t.owner === '지후').sort((a,b) => a.time.localeCompare(b.time));

            if (jiaTasks.length === 0) jiaContainer.innerHTML = `<p class="text-sm text-gray-500">완료한 할일이 없습니다.</p>`;
            jiaTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'text-sm p-2 bg-gray-50 rounded';
                taskEl.textContent = `${formatTimeForDisplay(task.time)} - ${task.text} (+${task.points}P)`;
                jiaContainer.appendChild(taskEl);
            });

            if (jihuTasks.length === 0) jihuContainer.innerHTML = `<p class="text-sm text-gray-500">완료한 할일이 없습니다.</p>`;
            jihuTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'text-sm p-2 bg-gray-50 rounded';
                taskEl.textContent = `${formatTimeForDisplay(task.time)} - ${task.text} (+${task.points}P)`;
                jihuContainer.appendChild(taskEl);
            });
        };

        const renderAdminCashExchanges = (requests) => {
            const container = adminCashExchangesContainer;
            container.innerHTML = '';
            if (requests.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">환전 요청이 없습니다.</p>`;
                return;
            }
            requests.sort((a, b) => (b.requestedAt?.toMillis() || 0) - (a.requestedAt?.toMillis() || 0));
            requests.forEach(req => {
                const reqEl = document.createElement('div');
                reqEl.className = 'bg-gray-50 p-3 rounded-lg flex justify-between items-center';
                const date = req.requestedAt ? req.requestedAt.toDate().toLocaleDateString('ko-KR') : '날짜 없음';
                reqEl.innerHTML = `
                    <div>
                        <p class="font-bold">${req.userId}님의 요청</p>
                        <p class="text-sm text-green-600">${req.pointsExchanged.toLocaleString()} 포인트 환전</p>
                        <p class="text-xs text-gray-500">${date}</p>
                    </div>
                    <button data-id="${req.id}" class="complete-exchange-btn bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 text-sm">완료 처리</button>
                `;
                container.appendChild(reqEl);
            });
        };

        const renderShopItems = (items) => {
            shopItemsContainer.innerHTML = '';
            if (items.length === 0) {
                shopItemsContainer.innerHTML = `<p class="text-center text-gray-500 mt-10">등록된 상품이 없습니다.</p>`;
                return;
            }
            items.forEach(item => {
                const isCashItem = item.type === 'cash';
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
                itemEl.innerHTML = `
                    <div>
                        <p class="text-lg font-bold">${item.name} ${isCashItem ? '💰' : ''}</p>
                        <p class="text-purple-600 font-bold">${isCashItem ? '포인트 차감' : item.points.toLocaleString() + ' P'}</p>
                    </div>
                    <button data-id="${item.id}" data-name="${item.name}" data-points="${item.points}" data-type="${item.type || 'coupon'}" class="buy-item-btn bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">${isCashItem ? '환전' : '구매'}</button>
                `;
                shopItemsContainer.appendChild(itemEl);
            });
        };

        const renderAdminShopItems = (items) => {
             adminShopItemsContainer.innerHTML = '';
            if (items.length === 0) {
                adminShopItemsContainer.innerHTML = `<p class="text-center text-gray-500 mt-4">등록된 상품이 없습니다. 위에서 추가해주세요.</p>`;
                return;
            }
            items.forEach(item => {
                const isCashItem = item.type === 'cash';
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
                itemEl.innerHTML = `
                    <div>
                        <p class="text-lg font-bold">${item.name} ${isCashItem ? '💰' : ''}</p>
                        <p class="text-purple-600 font-bold">${isCashItem ? '포인트 차감' : item.points.toLocaleString() + ' P'}</p>
                    </div>
                    <button data-id="${item.id}" class="delete-item-btn bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">삭제</button>
                `;
                adminShopItemsContainer.appendChild(itemEl);
            });
        };
        
        const updateDateUI = () => {
            const dateInfo = getRelativeDateInfo(currentDate);
            const dateString = `${currentDate.getMonth() + 1}월 ${currentDate.getDate()}일 (${dateInfo.label})`;
            
            currentDateDisplay.textContent = dateString;
            addTaskModalTitle.textContent = `${dateInfo.label} 할 일 추가`;
            
            showAddTaskModalBtn.style.display = dateInfo.isPast ? 'none' : 'flex';
        };

        const updateUIForUser = () => {
            shopUserName.textContent = currentAppUser;
            subscribeToData();
        };
        
        const playSoundAndAnimate = (event, isChecked) => {
             const synth = new window.Tone.Synth().toDestination();
            if (typeof window.Tone !== 'undefined') {
                if (window.Tone.context.state !== 'running') window.Tone.start();
                if (isChecked) {
                    synth.triggerAttackRelease("C5", "8n", window.Tone.now());
                } else {
                    synth.triggerAttackRelease("G4", "8n", window.Tone.now());
                }
            }
            if (isChecked) {
                const rect = event.target.getBoundingClientRect(), appRect = appEl.getBoundingClientRect();
                const emoji = document.createElement('span');
                const emojis = ['✨', '🎉', '👍', '✅', '💯', '⭐'];
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.className = 'emoji-animation text-3xl';
                emoji.style.left = `${rect.left - appRect.left}px`;
                emoji.style.top = `${rect.top - appRect.top}px`;
                appEl.appendChild(emoji);
                emoji.addEventListener('animationend', () => emoji.remove());
            }
        };

        // --- Gemini API 로직 ---
        const callGeminiAPI = async (prompt) => {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            
            const apiKey = ""; // API 키는 비워 둡니다.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    throw new Error("No text returned from API.");
                }
                return text.trim();
            } catch (error) {
                console.error("Gemini API Error:", error);
                showModal("AI 기능 사용 중 오류가 발생했습니다.");
                return null;
            } finally {
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');
            }
        };

        // --- Firestore 로직 ---
        const subscribeToData = () => {
            if (!currentUser) return; // 인증이 완료될 때까지 대기
            if (tasksUnsubscribe) { tasksUnsubscribe(); tasksUnsubscribe = null; }
            if (userUnsubscribe) { userUnsubscribe(); userUnsubscribe = null; }
            if (shopUnsubscribe) { shopUnsubscribe(); shopUnsubscribe = null; }
            if (adminTasksUnsubscribe) { adminTasksUnsubscribe(); adminTasksUnsubscribe = null; }
            if (adminCashUnsubscribe) { adminCashUnsubscribe(); adminCashUnsubscribe = null; }
            if (designUnsubscribe) { designUnsubscribe(); designUnsubscribe = null; }

            const designDocRef = doc(db, `artifacts/${appId}/public/data/designConfig/main`);
            designUnsubscribe = onSnapshot(designDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const designData = docSnap.data();
                    if (designData.headerBgBase64) {
                        appHeader.style.backgroundImage = `url(${designData.headerBgBase64})`;
                        appHeader.style.backgroundSize = 'cover';
                        appHeader.style.backgroundPosition = 'center';
                        appHeader.classList.remove('bg-gradient-to-br', 'from-purple-500', 'to-pink-500');
                    } else {
                        appHeader.style.backgroundImage = '';
                        appHeader.classList.add('bg-gradient-to-br', 'from-purple-500', 'to-pink-500');
                    }

                    if (designData.profileBgBase64) {
                        document.getElementById('profile-section').style.backgroundImage = `url(${designData.profileBgBase64})`;
                        document.getElementById('profile-section').style.backgroundSize = 'cover';
                        document.getElementById('profile-section').style.backgroundPosition = 'center';
                    } else {
                        document.getElementById('profile-section').style.backgroundImage = '';
                    }

                    if (designData.adminProfileImgBase64) {
                         adminProfileImg.src = designData.adminProfileImgBase64;
                    } else {
                         adminProfileImg.src = userProfiles['관리자'].img;
                    }
                } else {
                     adminProfileImg.src = userProfiles['관리자'].img;
                }
            });

            const shopItemsRef = collection(db, `artifacts/${appId}/public/data/shopItems`);
            shopUnsubscribe = onSnapshot(shopItemsRef, (snapshot) => {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderShopItems(items);
                if (currentAppUser === '관리자') {
                   renderAdminShopItems(items);
                }
            });

            if (currentAppUser === '관리자') {
                showAdminPage();
                const todayString = dateToYYYYMMDD(new Date());
                const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
                const qAdminTasks = query(tasksRef, where("date", "==", todayString), where("completed", "==", true));
                adminTasksUnsubscribe = onSnapshot(qAdminTasks, (snapshot) => {
                    const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAdminCompletedTasks(tasks);
                });
                
                const cashExchangesRef = collection(db, `artifacts/${appId}/public/data/cashExchanges`);
                adminCashUnsubscribe = onSnapshot(cashExchangesRef, (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAdminCashExchanges(requests);
                });

                getDoc(doc(db, `artifacts/${appId}/public/data/users/지아`)).then(doc => { if(doc.exists()) adminMessageJia.value = doc.data().adminMessage || ''});
                getDoc(doc(db, `artifacts/${appId}/public/data/users/지후`)).then(doc => { if(doc.exists()) adminMessageJihu.value = doc.data().adminMessage || ''});

                return;
            }
            
            showHomePage();

            const dateInfo = getRelativeDateInfo(currentDate);
            const dateString = dateToYYYYMMDD(currentDate);

            const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
            const qTasks = query(tasksRef, where("owner", "==", currentAppUser), where("date", "==", dateString));
            tasksUnsubscribe = onSnapshot(qTasks, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(tasks, dateInfo.isPast);
            });

            const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
            userUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const points = userData.points || 0;
                    totalPointsDisplays.forEach(el => el.textContent = points.toLocaleString());
                    
                    if(userData.adminMessage) {
                        adminMessageDisplay.textContent = `${userData.adminMessage}`;
                    } else {
                        adminMessageDisplay.textContent = "";
                    }
                    
                    userQuoteDisplay.textContent = userData.quote || userProfiles[currentAppUser].quote;
                    
                    if (userData.profileImgBase64) {
                        profileImg.src = userData.profileImgBase64;
                    } else {
                        profileImg.src = userProfiles[currentAppUser].img;
                    }
                    
                    const todayString = dateToYYYYMMDD(new Date());
                    const dateInfo = getRelativeDateInfo(currentDate);

                    if (dateInfo.isToday) {
                        endDayBtn.style.display = 'block';
                        if (userData.lastCompletionDate === todayString) {
                            endDayBtn.textContent = '오늘 미션 완료! 🎉';
                            endDayBtn.disabled = true;
                        } else {
                            endDayBtn.textContent = '오늘 하루 끝';
                            endDayBtn.disabled = false;
                        }
                    } else {
                        endDayBtn.style.display = 'none';
                    }

                } else {
                    // 사용자가 존재하지 않으면 기본값으로 생성
                    profileImg.src = userProfiles[currentAppUser].img;
                    setDoc(userDocRef, { name: currentAppUser, points: 0, lastCompletionDate: null, profileImgBase64: null, adminMessage: '', quote: userProfiles[currentAppUser].quote });
                }
            });
        };
        
        const handlePostponeTask = async (taskId, timeString) => {
            const [hours, minutes] = timeString.split(':').map(Number);
            let newHours = hours + 1;

            if (newHours >= 24) {
                showModal("23시 이후의 일정은 더 이상 미룰 수 없습니다.");
                return;
            }
            const newTimeString = `${String(newHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

            const taskDocRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);

            try {
                const userDoc = await getDoc(userDocRef);
                const currentPoints = userDoc.exists() ? userDoc.data().points : 0;
                
                await updateDoc(taskDocRef, { time: newTimeString });
                await setDoc(userDocRef, { points: Math.max(0, currentPoints - 100) }, { merge: true });
            } catch(e) {
                showModal("일정 미루기에 실패했습니다.");
                console.error(e);
            }
        };

        const resizeImage = (file, maxWidth, maxHeight, quality) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/png'));
                    }
                    img.onerror = (error) => reject(error);
                }
                reader.onerror = (error) => reject(error);
            });
        };


        const handleProfileImageUpload = async (event, targetUser) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const resizedBase64 = await resizeImage(file, 200, 200, 0.8);
                if(!resizedBase64) return;
                
                const userToUpdate = targetUser || currentAppUser;

                if (userToUpdate === '관리자') {
                    const designDocRef = doc(db, `artifacts/${appId}/public/data/designConfig/main`);
                    await setDoc(designDocRef, { adminProfileImgBase64: resizedBase64 }, { merge: true });
                } else {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${userToUpdate}`);
                    await setDoc(userDocRef, { profileImgBase64: resizedBase64 }, { merge: true });
                }

                showModal(`${userToUpdate}의 프로필 사진이 변경되었습니다.`);

            } catch (err) {
                showModal('프로필 사진 업데이트에 실패했습니다.');
                console.error("Profile image upload error:", err);
            } finally {
                event.target.value = '';
            }
        };
        
        const handleBgImageUpload = async (event, type) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                let resizedBase64;
                if (type === 'header') {
                    resizedBase64 = await resizeImage(file, 800, 300, 0.8);
                } else if (type === 'profile') {
                    resizedBase64 = await resizeImage(file, 600, 200, 0.8);
                }

                if (!resizedBase64) return;
                const designDocRef = doc(db, `artifacts/${appId}/public/data/designConfig/main`);
                
                if (type === 'header') {
                    await setDoc(designDocRef, { headerBgBase64: resizedBase64 }, { merge: true });
                } else if (type === 'profile') {
                    await setDoc(designDocRef, { profileBgBase64: resizedBase64 }, { merge: true });
                }
                showModal(`${type === 'header' ? '헤더' : '프로필'} 배경 이미지가 저장되었습니다.`);
            } catch (err) {
                showModal('이미지 처리 중 오류가 발생했습니다.');
                console.error("Image resize/upload error:", err);
            } finally {
                event.target.value = ''; // Reset file input
            }
        };


        const handleAddTask = async () => {
            const task = {
                text: newTaskTextInput.value.trim(), time: newTaskTimeInput.value,
                points: parseInt(newTaskPointsInput.value, 10), memo: newTaskMemoInput.value.trim(),
                category: newTaskCategoryInput.value
            };
            if (!task.text || !task.time || isNaN(task.points)) {
                showModal('시간, 할 일, 포인트를 모두 올바르게 입력해주세요.'); return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), {
                    ...task, owner: currentAppUser, completed: false,
                    completedTime: null, link: null, date: dateToYYYYMMDD(currentDate),
                });
                newTaskTextInput.value = ''; newTaskPointsInput.value = ''; newTaskMemoInput.value = '';
                addTaskModal.classList.add('hidden'); addTaskModal.classList.remove('flex');
            } catch (e) { showModal('할 일 추가에 실패했습니다.'); console.error(e); }
        };

        const handleAdminAddTask = async () => {
            const selectedUser = adminAddTaskUser.value;
            const commonTaskData = {
                date: adminAddTaskDate.value,
                time: adminAddTaskTime.value,
                text: adminAddTaskText.value.trim(),
                points: parseInt(adminAddTaskPoints.value, 10),
                category: "개인활동", // 기본값
                memo: "관리자가 등록한 할일",
                completed: false,
                completedTime: null,
                link: null
            };

            if (!selectedUser || !commonTaskData.date || !commonTaskData.time || !commonTaskData.text || isNaN(commonTaskData.points)) {
                showModal("모든 항목을 올바르게 입력해주세요.");
                return;
            }
            try {
                if (selectedUser === '모두') {
                    const batch = writeBatch(db);
                    const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);

                    const taskForJia = { ...commonTaskData, owner: '지아' };
                    batch.set(doc(tasksRef), taskForJia);

                    const taskForJihu = { ...commonTaskData, owner: '지후' };
                    batch.set(doc(tasksRef), taskForJihu);

                    await batch.commit();
                    showModal(`지아와 지후 모두에게 할 일을 등록했습니다.`);
                } else {
                    const task = { ...commonTaskData, owner: selectedUser };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), task);
                    showModal(`${selectedUser}님에게 할 일을 등록했습니다.`);
                }

                adminAddTaskDate.value = dateToYYYYMMDD(new Date());
                adminAddTaskText.value = '';
                adminAddTaskPoints.value = '';

            } catch (e) {
                showModal("할 일 등록에 실패했습니다.");
                console.error(e);
            }
        };

        const handleToggleTask = async (event, taskId, isChecked) => {
            playSoundAndAnimate(event, isChecked);
            const taskDocRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            try {
                let formattedCompletedTime = null;
                if (isChecked) {
                    const now = new Date();
                    const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    formattedCompletedTime = formatTimeForDisplay(timeString);
                }
                await updateDoc(taskDocRef, { 
                    completed: isChecked, 
                    completedTime: formattedCompletedTime
                });
            } catch (e) { console.error("Error updating task: ", e); }
        };

        const handleDeleteTask = async (taskId) => {
            showConfirm('정말로 이 할 일을 삭제하시겠습니까?', async () => {
                try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId)); } 
                catch (e) { showModal('할 일 삭제에 실패했습니다.'); console.error(e); }
            }, '삭제');
        };
        
        const handleEndDay = async () => {
             if (typeof window.Tone !== 'undefined') {
                if (window.Tone.context.state !== 'running') window.Tone.start();
                 const synth = new window.Tone.Synth().toDestination();
                synth.triggerAttackRelease("C4", "8n", window.Tone.now());
                synth.triggerAttackRelease("E4", "8n", window.Tone.now() + 0.2);
                synth.triggerAttackRelease("G4", "8n", window.Tone.now() + 0.4);
            }

            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const todayString = dateToYYYYMMDD(today);
            const tomorrowString = dateToYYYYMMDD(tomorrow);

            const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
            const qToday = query(tasksRef, where("owner", "==", currentAppUser), where("date", "==", todayString));

            try {
                const querySnapshot = await getDocs(qToday);
                let pointsToday = 0;
                const batch = writeBatch(db);

                querySnapshot.forEach(doc => {
                    const task = doc.data();
                    if (task.completed) {
                        pointsToday += task.points;
                    } else {
                        const taskRef = doc.ref;
                        batch.update(taskRef, {
                            date: tomorrowString,
                            points: 0
                        });
                    }
                });

                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                     batch.set(userDocRef, {
                        points: (userDocSnap.data().points || 0) + pointsToday,
                        lastCompletionDate: todayString
                    }, { merge: true });
                }
                
                await batch.commit();

                showModal(`오늘 하루를 마감했습니다! ${pointsToday} 포인트를 획득했습니다!`);

            } catch (e) {
                showModal('오늘 하루 마감 처리에 실패했습니다.');
                console.error(e);
            }
        };

        const handlePurchaseAndCreateTask = async (itemId, itemName, itemPoints, selectedDate, selectedTime) => {
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
            try {
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) { showModal("사용자 정보를 찾을 수 없습니다."); return; }

                const currentPoints = userDoc.data().points || 0;
                if (currentPoints < itemPoints) { showModal("포인트가 부족합니다!"); return; }
                
                const newPoints = currentPoints - itemPoints;
                const batch = writeBatch(db);
                
                // 1. Update user points
                batch.set(userDocRef, { points: newPoints }, { merge: true });
                
                // 2. Add to purchases log
                const purchasesRef = collection(db, `artifacts/${appId}/public/data/purchases`);
                batch.set(doc(purchasesRef), {
                    userId: currentAppUser,
                    itemName: itemName,
                    points: itemPoints,
                    purchasedAt: serverTimestamp()
                });

                // 3. Add to tasks as a coupon/reward
                const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
                batch.set(doc(tasksRef), {
                    owner: currentAppUser, text: `[쿠폰] ${itemName}`, memo: "포인트 상점에서 구매한 보상",
                    points: 0, date: selectedDate, time: selectedTime,
                    completed: false, completedTime: null, category: "보상", link: null,
                });

                await batch.commit();
                showModal(`'${itemName}' 쿠폰을 ${selectedDate}에 사용하도록 등록했습니다!`);

            } catch (e) {
                showModal("구매 처리 중 오류가 발생했습니다.");
                console.error(e);
            }
        };

         const handleCashExchange = async (itemName) => {
            const amount = parseInt(cashExchangeAmountInput.value, 10);
            if (isNaN(amount) || amount <= 0) {
                showModal("올바른 환전 포인트를 입력해주세요.");
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
            try {
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) { showModal("사용자 정보를 찾을 수 없습니다."); return; }

                const currentPoints = userDoc.data().points || 0;
                if (currentPoints < amount) {
                    showModal("보유 포인트가 부족합니다!");
                    return;
                }

                const newPoints = currentPoints - amount;
                const batch = writeBatch(db);

                // 1. Update user points
                batch.set(userDocRef, { points: newPoints }, { merge: true });

                // 2. Add to a new collection for cash exchange requests
                const cashExchangesRef = collection(db, `artifacts/${appId}/public/data/cashExchanges`);
                batch.set(doc(cashExchangesRef), {
                    userId: currentAppUser,
                    itemName: itemName,
                    pointsExchanged: amount,
                    requestedAt: serverTimestamp()
                });

                await batch.commit();
                showModal(`${amount.toLocaleString()}포인트 환전 신청이 완료되었습니다.`);

            } catch (e) {
                showModal("환전 처리 중 오류가 발생했습니다.");
                console.error(e);
            }
        };
        
        const handleAddShopItem = async () => {
            const name = newItemName.value.trim();
            const points = parseInt(newItemPoints.value, 10);
            const isCash = newItemIsCash.checked; 

            if (!name || isNaN(points) || points < 0) {
                showModal("상품 이름과 올바른 포인트를 입력해주세요.");
                return;
            }
            const itemData = { name, points, type: isCash ? 'cash' : 'coupon' };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/shopItems`), itemData);
                newItemName.value = '';
                newItemPoints.value = '';
                newItemIsCash.checked = false;
            } catch (e) {
                showModal("상품 추가에 실패했습니다.");
                console.error(e);
            }
        };
        
        const handleDeleteShopItem = async (itemId) => {
            showConfirm("정말로 이 상품을 삭제하시겠습니까?", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/shopItems`, itemId));
                } catch (e) {
                    showModal("상품 삭제에 실패했습니다.");
                }
            }, "삭제");
        };

        const handleSaveMessages = async () => {
            const jiaMessage = adminMessageJia.value.trim();
            const jihuMessage = adminMessageJihu.value.trim();
            try {
                const jiaDocRef = doc(db, `artifacts/${appId}/public/data/users/지아`);
                const jihuDocRef = doc(db, `artifacts/${appId}/public/data/users/지후`);
                await setDoc(jiaDocRef, { adminMessage: jiaMessage }, { merge: true });
                await setDoc(jihuDocRef, { adminMessage: jihuMessage }, { merge: true });
                showModal("메시지를 저장했습니다.");
            } catch(e) {
                showModal("메시지 저장에 실패했습니다.");
                console.error(e);
            }
        };
        
        const handleCompleteExchange = async (exchangeId) => {
            showConfirm("이 환전 요청을 완료 처리하시겠습니까? 목록에서 삭제됩니다.", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/cashExchanges`, exchangeId));
                    showModal("환전 요청을 완료 처리했습니다.");
                } catch (e) {
                    showModal("처리 중 오류가 발생했습니다.");
                    console.error(e);
                }
            }, "완료", "bg-green-500");
        };

        const handleImportCSV = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const rows = e.target.result.split('\n').slice(1);
                let addedCount = 0;
                for (const row of rows) {
                    if (row.trim() === '') continue;
                    const [date, time, text, memo, pointsStr, status, completedTime, category, link] = row.split(',').map(s => s.trim());
                    const points = parseInt(pointsStr, 10);
                    if (date && time && text && !isNaN(points)) {
                         try {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), {
                                owner: currentAppUser, text, time, memo, points, date,
                                completed: status === '완료', completedTime, category, link,
                            });
                            addedCount++;
                        } catch (err) { console.error("CSV 항목 추가 오류: ", err); }
                    }
                }
                showModal(`${addedCount}개의 할 일을 성공적으로 등록했습니다.`);
            };
            reader.readAsText(file, 'utf-8');
            csvFileInput.value = '';
        };
        
        const checkForRolloverTasks = async () => {
            const todayString = dateToYYYYMMDD(new Date());
            const tasksRef = collection(db, `artifacts/${appId}/public/data/tasks`);
            const q = query(tasksRef,
                where("owner", "==", currentAppUser),
                where("completed", "==", false)
            );

            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            
            snapshot.forEach(doc => {
                const task = doc.data();
                if (task.date < todayString) {
                    const taskRef = doc.ref;
                    batch.update(taskRef, {
                        date: todayString,
                        points: 0
                    });
                }
            });

            await batch.commit();
        };

        const seedShopItems = async () => {
             const shopItemsRef = collection(db, `artifacts/${appId}/public/data/shopItems`);
             const snapshot = await getDocs(shopItemsRef);
             if (snapshot.empty) {
                const items = [
                    { name: "게임 1시간", points: 5000, type: 'coupon' },
                    { name: "하루동안 잔소리 금지", points: 10000, type: 'coupon' },
                    { name: "현금 환전", points: 0, type: 'cash' }
                ];
                const batch = writeBatch(db);
                items.forEach(item => {
                    const docRef = doc(shopItemsRef);
                    batch.set(docRef, item);
                });
                await batch.commit();
             }
        };

        const changeDate = (offset) => {
            currentDate.setDate(currentDate.getDate() + offset);
            updateDateUI();
            subscribeToData();
        };

        // --- 이벤트 리스너 ---
        settingsBtn.addEventListener('click', () => {
            document.querySelector(`input[name="user-select"][value="${currentAppUser}"]`).checked = true;
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
        });

        cancelSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        });

        saveSettingsBtn.addEventListener('click', () => {
            const selectedUser = document.querySelector('input[name="user-select"]:checked').value;
            localStorage.setItem('fixedAppUser', selectedUser);
            currentAppUser = selectedUser;
            updateUIForUser();
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        });

        profileImg.addEventListener('click', () => {
            if (currentAppUser !== '관리자') {
                profileUploadInput.click()
            }
        });
        profileUploadInput.addEventListener('change', (e) => handleProfileImageUpload(e, null));
        
        uploadJiaProfileBtn.addEventListener('click', () => { adminProfileUploadTarget = '지아'; adminProfileUploadInput.click(); });
        uploadJihuProfileBtn.addEventListener('click', () => { adminProfileUploadTarget = '지후'; adminProfileUploadInput.click(); });
        uploadAdminProfileBtn.addEventListener('click', () => { adminProfileUploadTarget = '관리자'; adminProfileUploadInput.click(); });
        adminProfileUploadInput.addEventListener('change', (e) => handleProfileImageUpload(e, adminProfileUploadTarget));


        uploadHeaderBgBtn.addEventListener('click', () => headerBgUploadInput.click());
        uploadProfileBgBtn.addEventListener('click', () => profileBgUploadInput.click());
        headerBgUploadInput.addEventListener('change', (e) => handleBgImageUpload(e, 'header'));
        profileBgUploadInput.addEventListener('change', (e) => handleBgImageUpload(e, 'profile'));

        prevDayBtn.addEventListener('click', () => changeDate(-1));
        nextDayBtn.addEventListener('click', () => changeDate(1));
        showAddTaskModalBtn.addEventListener('click', () => { addTaskModal.classList.remove('hidden'); addTaskModal.classList.add('flex'); });
        cancelAddTaskBtn.addEventListener('click', () => { addTaskModal.classList.add('hidden'); addTaskModal.classList.remove('flex'); });
        confirmAddTaskBtn.addEventListener('click', handleAddTask);
        endDayBtn.addEventListener('click', handleEndDay);
        importCsvBtn.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', handleImportCSV);
        modalCloseBtn.addEventListener('click', hideModal);
        
        shopBtn.addEventListener('click', showShopPage);
        backToHomeBtn.addEventListener('click', showHomePage);
        
        shopItemsContainer.addEventListener('click', async (e) => {
            const buyBtn = e.target.closest('.buy-item-btn');
            if (buyBtn) {
                const { id, name, points, type } = buyBtn.dataset;
                const itemPoints = Number(points);

                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
                const userDoc = await getDoc(userDocRef);
                const currentPoints = userDoc.exists() ? userDoc.data().points : 0;
                
                if (type === 'cash') {
                    cashExchangeModalTitle.textContent = `'${name}' 환전`;
                    cashExchangeCurrentPoints.textContent = currentPoints.toLocaleString();
                    confirmCashExchangeBtn.dataset.name = name;
                    cashExchangeAmountInput.value = '';
                    cashExchangeModal.classList.remove('hidden');
                    cashExchangeModal.classList.add('flex');
                } else {
                    if (currentPoints < itemPoints) {
                        showModal("포인트가 부족합니다!");
                        return;
                    }

                    purchaseModalTitle.textContent = `'${name}' 쿠폰 사용`;
                    purchaseDateInput.value = dateToYYYYMMDD(new Date()); 
                    purchaseDateInput.min = dateToYYYYMMDD(new Date()); 
                    
                    confirmPurchaseBtn.dataset.id = id;
                    confirmPurchaseBtn.dataset.name = name;
                    confirmPurchaseBtn.dataset.points = points;

                    purchaseModal.classList.remove('hidden');
                    purchaseModal.classList.add('flex');
                }
            }
        });
        
        cancelPurchaseBtn.addEventListener('click', () => {
            purchaseModal.classList.add('hidden');
            purchaseModal.classList.remove('flex');
        });

        confirmPurchaseBtn.addEventListener('click', () => {
            const { id, name, points } = confirmPurchaseBtn.dataset;
            const selectedDate = purchaseDateInput.value;
            const selectedTime = purchaseTimeInput.value;

            if (!selectedDate) {
                showModal("날짜를 선택해주세요.");
                return;
            }

            handlePurchaseAndCreateTask(id, name, Number(points), selectedDate, selectedTime);
            purchaseModal.classList.add('hidden');
            purchaseModal.classList.remove('flex');
        });

        cancelCashExchangeBtn.addEventListener('click', () => {
            cashExchangeModal.classList.add('hidden');
            cashExchangeModal.classList.remove('flex');
        });

        confirmCashExchangeBtn.addEventListener('click', () => {
            const { name } = confirmCashExchangeBtn.dataset;
            handleCashExchange(name);
            cashExchangeModal.classList.add('hidden');
            cashExchangeModal.classList.remove('flex');
        });
        
        addItemBtn.addEventListener('click', handleAddShopItem);
        adminShopItemsContainer.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-item-btn');
            if (deleteBtn) {
                handleDeleteShopItem(deleteBtn.dataset.id);
            }
        });
        
        saveMessagesBtn.addEventListener('click', handleSaveMessages);
        adminAddTaskBtn.addEventListener('click', handleAdminAddTask);

        confirmCancelBtn.addEventListener('click', () => { confirmCallback = null; confirmModal.classList.add('hidden'); confirmModal.classList.remove('flex'); });
        confirmOkBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
            confirmModal.classList.add('hidden');
            confirmModal.classList.remove('flex');
        });

        taskListEl.addEventListener('change', (e) => { 
            if (e.target.type === 'checkbox') handleToggleTask(e, e.target.dataset.id, e.target.checked);
        });
        taskListEl.addEventListener('click', (e) => { 
            const deleteBtn = e.target.closest('.delete-task-btn'); 
            if (deleteBtn) handleDeleteTask(deleteBtn.dataset.id);
            
            const postponeBtn = e.target.closest('.postpone-task-btn');
            if (postponeBtn) handlePostponeTask(postponeBtn.dataset.id, postponeBtn.dataset.time);
        });

        adminPage.addEventListener('click', (e) => {
            const completeBtn = e.target.closest('.complete-exchange-btn');
            if(completeBtn) {
                handleCompleteExchange(completeBtn.dataset.id);
            }
        });
        
        generateQuoteBtn.addEventListener('click', async () => {
            const prompt = `${currentAppUser}를 위한 짧고 힘이 되는 다짐 한마디를 한 문장으로 만들어줘.`;
            const newQuote = await callGeminiAPI(prompt);
            if (newQuote) {
                userQuoteDisplay.textContent = newQuote;
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
                await setDoc(userDocRef, { quote: newQuote }, { merge: true });
            }
        });

        userSpeechBubble.addEventListener('click', () => {
            if (currentAppUser !== '관리자') {
                editQuoteInput.value = userQuoteDisplay.textContent;
                quoteEditModal.classList.remove('hidden');
                quoteEditModal.classList.add('flex');
            }
        });

        cancelEditQuoteBtn.addEventListener('click', () => {
            quoteEditModal.classList.add('hidden');
            quoteEditModal.classList.remove('flex');
        });

        saveEditQuoteBtn.addEventListener('click', async () => {
            const newQuote = editQuoteInput.value.trim();
            if (newQuote) {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentAppUser}`);
                await setDoc(userDocRef, { quote: newQuote }, { merge: true });
                quoteEditModal.classList.add('hidden');
                quoteEditModal.classList.remove('flex');
            }
        });

        aiTaskRecommendBtn.addEventListener('click', async () => {
            const category = newTaskCategoryInput.value;
            const prompt = `오늘 ${currentAppUser}가 할 만한 ${category} 관련 활동 한 가지를 추천해줘. 할일 제목만 간결하게.`;
            const suggestedTask = await callGeminiAPI(prompt);
            if (suggestedTask) {
                newTaskTextInput.value = suggestedTask.replace(/["'.]/g, ''); // Remove quotes and periods
            }
        });


        // --- 앱 초기화 ---
        const setupApp = () => {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');

            populateTimeSelect(newTaskTimeInput);
            populateTimeSelect(purchaseTimeInput);
            populateTimeSelect(adminAddTaskTime);
            adminAddTaskDate.value = dateToYYYYMMDD(new Date());

            currentAppUser = localStorage.getItem('fixedAppUser') || '지아';
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    
                    if (currentAppUser !== '관리자') {
                        const todayString = dateToYYYYMMDD(new Date());
                        const lastVisit = localStorage.getItem(`lastVisitDate_${currentAppUser}`);
                        if (lastVisit !== todayString) {
                            await checkForRolloverTasks();
                            localStorage.setItem(`lastVisitDate_${currentAppUser}`, todayString);
                        }
                    }

                    await seedShopItems();
                    updateDateUI();
                    updateUIForUser();
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                } else {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' && __initial_auth_token;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Authentication failed: ", e);
                         loadingOverlay.innerHTML = `<div class="text-red-500 text-center">인증 실패.<br>페이지를 새로고침 해주세요.</div>`;
                    }
                }
            });
        };

        setupApp();

    </script>
</body>
</html>

